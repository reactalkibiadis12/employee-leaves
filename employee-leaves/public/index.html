<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Διαχείριση Αδειών Εργαζομένων</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .employee-list { margin-bottom: 20px; }
        .employee { display: flex; align-items: center; padding: 10px; border: 1px solid #ccc; margin: 5px 0; cursor: pointer; }
        .employee:hover { background-color: #f0f0f0; }
        .employee.selected { background-color: #d0e8ff; border: 2px solid #007bff; }
        .employee button { margin-left: 10px; padding: 5px 10px; }
        .details { display: none; border: 1px solid #ddd; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        .form-container, .edit-form { margin-bottom: 20px; display: none; }
        .edit-form { border: 1px solid #ccc; padding: 10px; background-color: #f9f9f9; }
        .leave-actions { display: flex; gap: 5px; }
        .dropdown { margin-bottom: 20px; }
        .report { margin-top: 20px; border: 1px solid #ddd; padding: 10px; }
        @media print {
            body * { visibility: hidden; }
            .print-header, .print-header *, #leaveTable, #leaveTable * { visibility: visible; }
            .print-header { position: absolute; top: 0; left: 0; width: 100%; }
            #leaveTable { position: absolute; top: 100px; left: 0; width: 100%; }
        }
    </style>
</head>
<body>
    <h1>Λίστα Εργαζομένων</h1>
    <div class="dropdown">
        <button onclick="toggleForm()">Προσθήκη Εργαζομένου ▼</button>
    </div>
    <div class="form-container" id="addEmployeeForm">
        <h3>Προσθήκη Νέου Εργαζομένου</h3>
        <input type="text" id="surname" placeholder="Επώνυμο"><br>
        <input type="text" id="name" placeholder="Όνομα"><br>
        <input type="text" id="afm" placeholder="ΑΦΜ"><br>
        <input type="email" id="email" placeholder="Email"><br>
        <button onclick="addEmployee()">Προσθήκη</button>
    </div>
    <div class="employee-list" id="employeeList"></div>

    <div class="edit-form" id="editForm">
        <h3>Επεξεργασία Εργαζομένου</h3>
        <input type="text" id="editSurname" placeholder="Επώνυμο"><br>
        <input type="text" id="editName" placeholder="Όνομα"><br>
        <input type="text" id="editAfm" placeholder="ΑΦΜ"><br>
        <input type="email" id="editEmail" placeholder="Email"><br>
        <button onclick="saveEdit()">Αποθήκευση</button>
        <button onclick="cancelEdit()">Ακύρωση</button>
    </div>

    <div class="details" id="employeeDetails">
        <h2 id="employeeName"></h2>
        <div class="summary">
            <label>Δικαιούται <span id="currentYearEntitled"></span>: <span id="entitled"></span></label><br>
            <label>Υπόλοιπα προηγούμενου έτους: <input type="number" id="previous" min="0" onchange="updateTotals()"></label><br>
            <label>Σύνολα <span id="currentYearTotal"></span>: <span id="total"></span></label><br>
            <label>Υπόλοιπα: <span id="remaining"></span></label>
        </div>
        <div class="print-header">
            <h3 id="printEmployeeDetails"></h3>
        </div>
        <table id="leaveTable">
            <thead>
                <tr>
                    <th>Α/Α</th><th>ΑΠΟ</th><th>ΕΩΣ</th><th>ΜΕΡΕΣ</th><th>ΚΑΝΟΝΙΚΗ</th><th>ΑΝΑΡ/ΚΗ</th><th>ΓΟΝΙΚΗ</th><th>ΕΚΠ/ΚΗ</th><th>Υ.Δ</th><th>ΑΙΜΟΔΟΣΙΑ</th><th>ΡΕΠΟ</th><th>ΑΛΛΗ</th><th>ΕΝΕΡΓΕΙΕΣ</th><th>ΥΠΑΛΛΗΛΟΣ</th><th>ΤΜΗΜΑΤΑΡΧΗΣ</th><th>ΠΡΟΪΣΤΑΜΕΝΟΣ</th>
                </tr>
            </thead>
            <tbody id="leaveTableBody"></tbody>
        </table>
        <button onclick="addLeaveRow()">Προσθήκη Άδειας</button>
        <button onclick="printLeaves()">Εκτύπωση Αδειών</button>
        <button onclick="generateReport()">Δημιουργία Αναφοράς</button>
        <div class="report" id="leaveReport" style="display: none;">
            <h3>Αναφορά Αδειών <span id="reportYear"></span></h3>
            <p>Σύνολο Ημερών Αδειών: <span id="totalLeaveDays"></span></p>
            <p>Κανονική: <span id="regularDays"></span></p>
            <p>Αναρρωτική: <span id="sickDays"></span></p>
            <p>Γονική: <span id="parentalDays"></span></p>
            <p>Εκπαιδευτική: <span id="educationalDays"></span></p>
            <p>Υ.Δ: <span id="specialDays"></span></p>
            <p>Αιμοδοσία: <span id="bloodDonationDays"></span></p>
            <p>Ρεπό: <span id="dayOffDays"></span></p>
            <p>Άλλη: <span id="otherDays"></span></p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
        const supabaseUrl = "https://nsrksmlqruogmckxpqer.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zcmtzbWxxcnVvZ21ja3hwcWVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE3NjYwNjQsImV4cCI6MjA1NzM0MjA2NH0.NydawPjtyBG83qH79uY6rWqCFZleJ6zfo-ZgkRw5QoY";
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let selectedEmployee = null;
        let leaves = [];
        let editingEmployee = null;
        const currentYear = new Date().getFullYear();

        function formatDate(dateStr) {
            if (!dateStr) return "";
            const date = new Date(dateStr);
            return `${date.getDate().toString().padStart(2, "0")}/${(date.getMonth() + 1).toString().padStart(2, "0")}/${date.getFullYear()}`;
        }

        function toggleForm() {
            const form = document.getElementById("addEmployeeForm");
            form.style.display = form.style.display === "block" ? "none" : "block";
        }

        async function loadEmployees() {
            const { data, error } = await supabase.from("employees").select("*");
            if (error) {
                console.error("Error loading employees:", error);
                return;
            }
            const employeeList = document.getElementById("employeeList");
            employeeList.innerHTML = "";
            data.forEach((emp) => {
                const div = document.createElement("div");
                div.className = `employee ${selectedEmployee && selectedEmployee.id === emp.id ? 'selected' : ''}`;
                div.innerHTML = `
                    <span onclick="showDetails(${emp.id})">${emp.surname} ${emp.name} | ${emp.afm} | ${emp.email}</span>
                    <button onclick="editEmployee(${emp.id})">Επεξεργασία</button>
                    <button onclick="deleteEmployee(${emp.id})">Διαγραφή</button>
                `;
                employeeList.appendChild(div);
            });
        }
        loadEmployees();

        async function addEmployee() {
            const surname = document.getElementById("surname").value;
            const name = document.getElementById("name").value;
            const afm = document.getElementById("afm").value;
            const email = document.getElementById("email").value;
            if (surname && name && afm && email) {
                const { error } = await supabase.from("employees").insert({
                    surname, name, afm, email, previous: 0, entitled_2025: 25, total_2025: 25, remaining: 25
                });
                if (error) {
                    console.error("Error adding employee:", error);
                    return;
                }
                loadEmployees();
                document.getElementById("surname").value = "";
                document.getElementById("name").value = "";
                document.getElementById("afm").value = "";
                document.getElementById("email").value = "";
                toggleForm();
            } else {
                alert("Συμπληρώστε όλα τα πεδία!");
            }
        }

        async function deleteEmployee(id) {
            if (confirm("Είστε σίγουροι ότι θέλετε να διαγράψετε αυτόν τον εργαζόμενο;")) {
                const { error: leavesError } = await supabase
                    .from("leaves")
                    .delete()
                    .eq("employee_id", id);
                if (leavesError) {
                    console.error("Error deleting leaves:", leavesError);
                    return;
                }
                const { error } = await supabase
                    .from("employees")
                    .delete()
                    .eq("id", id);
                if (error) {
                    console.error("Error deleting employee:", error);
                    return;
                }
                loadEmployees();
                if (selectedEmployee && selectedEmployee.id === id) {
                    document.getElementById("employeeDetails").style.display = "none";
                    selectedEmployee = null;
                }
                if (editingEmployee && editingEmployee.id === id) {
                    document.getElementById("editForm").style.display = "none";
                    editingEmployee = null;
                }
            }
        }

        async function editEmployee(id) {
            const { data, error } = await supabase
                .from("employees")
                .select("*")
                .eq("id", id)
                .single();
            if (error) {
                console.error("Error fetching employee for edit:", error);
                return;
            }
            editingEmployee = data;
            document.getElementById("editSurname").value = data.surname;
            document.getElementById("editName").value = data.name;
            document.getElementById("editAfm").value = data.afm;
            document.getElementById("editEmail").value = data.email;
            document.getElementById("editForm").style.display = "block";
        }

        async function saveEdit() {
            const surname = document.getElementById("editSurname").value;
            const name = document.getElementById("editName").value;
            const afm = document.getElementById("editAfm").value;
            const email = document.getElementById("editEmail").value;
            if (surname && name && afm && email) {
                const { error } = await supabase
                    .from("employees")
                    .update({ surname, name, afm, email })
                    .eq("id", editingEmployee.id);
                if (error) {
                    console.error("Error updating employee:", error);
                    return;
                }
                loadEmployees();
                document.getElementById("editForm").style.display = "none";
                if (selectedEmployee && selectedEmployee.id === editingEmployee.id) {
                    selectedEmployee = { ...selectedEmployee, surname, name, afm, email };
                    document.getElementById("employeeName").textContent = `${surname} ${name}`;
                }
                editingEmployee = null;
            } else {
                alert("Συμπληρώστε όλα τα πεδία!");
            }
        }

        function cancelEdit() {
            document.getElementById("editForm").style.display = "none";
            editingEmployee = null;
        }

        async function showDetails(id) {
            const { data, error } = await supabase
                .from("employees")
                .select("*")
                .eq("id", id)
                .single();
            if (error) {
                console.error("Error loading employee details:", error);
                return;
            }
            selectedEmployee = data;
            document.getElementById("employeeDetails").style.display = "block";
            document.getElementById("employeeName").textContent = `${data.surname} ${data.name}`;
            document.getElementById("printEmployeeDetails").textContent = `Εργαζόμενος: ${data.surname} ${data.name} | ΑΦΜ: ${data.afm} | Email: ${data.email}`;
            document.getElementById("previous").value = data.previous || 0;
            document.getElementById("entitled").textContent = data.entitled_2025;
            document.getElementById("total").textContent = data.total_2025;
            document.getElementById("remaining").textContent = data.remaining;
            document.getElementById("currentYearEntitled").textContent = currentYear;
            document.getElementById("currentYearTotal").textContent = currentYear;
            const { data: leavesData, error: leavesError } = await supabase
                .from("leaves")
                .select("*")
                .eq("employee_id", data.id);
            if (leavesError) {
                console.error("Error loading leaves:", leavesError);
                return;
            }
            leaves = leavesData.map(leave => ({ ...leave, saved: true }));
            renderLeaveTable();
            loadEmployees(); // Ενημερώνει την ένδειξη επιλογής
        }

        function addLeaveRow() {
            const tbody = document.getElementById("leaveTableBody");
            const rowIndex = leaves.length;
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${rowIndex + 1}</td>
                <td><input type="date" onchange="calculateDays(this, ${rowIndex})"></td>
                <td><input type="date" onchange="calculateDays(this, ${rowIndex})"></td>
                <td><span class="days">0</span></td>
                <td><input type="radio" name="leave${rowIndex}" value="regular" onchange="updateLeave(${rowIndex})"></td>
                <td><input type="radio" name="leave${rowIndex}" value="sick" onchange="updateLeave(${rowIndex})"></td>
                <td><input type="radio" name="leave${rowIndex}" value="parental" onchange="updateLeave(${rowIndex})"></td>
                <td><input type="radio" name="leave${rowIndex}" value="educational" onchange="updateLeave(${rowIndex})"></td>
                <td><input type="radio" name="leave${rowIndex}" value="special" onchange="updateLeave(${rowIndex})"></td>
                <td><input type="radio" name="leave${rowIndex}" value="blood_donation" onchange="updateLeave(${rowIndex})"></td>
                <td><input type="radio" name="leave${rowIndex}" value="day_off" onchange="updateLeave(${rowIndex})"></td>
                <td><input type="radio" name="leave${rowIndex}" value="other" onchange="updateLeave(${rowIndex})"></td>
                <td class="leave-actions">
                    <button onclick="saveLeave(${rowIndex})">Save</button>
                    <button onclick="deleteLeave(${rowIndex})" disabled>Delete</button>
                </td>
                <td></td><td></td><td></td>
            `;
            tbody.appendChild(row);
            leaves.push({
                employee_id: selectedEmployee.id,
                from_date: "",
                to_date: "",
                days: 0,
                type: "",
                saved: false
            });
        }

        function calculateDays(input, index) {
            const row = input.parentElement.parentElement;
            const fromInput = row.cells[1].querySelector("input");
            const toInput = row.cells[2].querySelector("input");
            const from = fromInput.value;
            const to = toInput.value;
            if (from && to) {
                const start = new Date(from);
                const end = new Date(to);
                if (end < start) {
                    alert("Η ημερομηνία ΕΩΣ πρέπει να είναι ίδια ή μεταγενέστερη από την ΑΠΟ!");
                    toInput.value = from;
                    return;
                }
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                row.cells[3].querySelector(".days").textContent = days;
                leaves[index].from_date = from;
                leaves[index].to_date = to;
                leaves[index].days = days;
            }
        }

        function updateLeave(index) {
            const row = document.getElementById("leaveTableBody").rows[index];
            const selectedType = row.querySelector(`input[name="leave${index}"]:checked`);
            leaves[index].type = selectedType ? selectedType.value : "";
        }

        async function saveLeave(index) {
            const leave = leaves[index];
            if (!leave.from_date || !leave.to_date) {
                alert("Παρακαλώ συμπληρώστε τις ημερομηνίες ΑΠΟ και ΕΩΣ!");
                return;
            }
            if (!leave.type) {
                alert("Παρακαλώ επιλέξτε έναν τύπο άδειας!");
                return;
            }
            const leaveData = {
                employee_id: selectedEmployee.id,
                from_date: leave.from_date,
                to_date: leave.to_date,
                days: leave.days,
                regular: leave.type === "regular",
                sick: leave.type === "sick",
                parental: leave.type === "parental",
                educational: leave.type === "educational",
                special: leave.type === "special",
                blood_donation: leave.type === "blood_donation",
                day_off: leave.type === "day_off",
                other: leave.type === "other"
            };
            const { data, error } = await supabase
                .from("leaves")
                .insert(leaveData)
                .select();
            if (error) {
                console.error("Error saving leave:", error);
                return;
            }
            leaves[index] = data[0];
            leaves[index].saved = true;
            leaves[index].type = Object.keys(leaveData).find(key => leaveData[key] === true);
            renderLeaveTable();
            await updateTotals();
        }

        async function deleteLeave(index) {
            const leave = leaves[index];
            if (!leave.saved) {
                leaves.splice(index, 1);
                renderLeaveTable();
                return;
            }
            if (confirm("Είστε σίγουροι ότι θέλετε να διαγράψετε αυτήν την άδεια;")) {
                const { error } = await supabase
                    .from("leaves")
                    .delete()
                    .eq("id", leave.id);
                if (error) {
                    console.error("Error deleting leave:", error);
                    return;
                }
                leaves.splice(index, 1);
                renderLeaveTable();
                await updateTotals();
            }
        }

        async function updateTotals() {
            const previous = parseInt(document.getElementById("previous").value) || 0;
            let regularDays = 0;
            leaves.forEach(leave => {
                if (leave.saved && leave.regular) regularDays += leave.days;
            });
            const entitled_2025 = selectedEmployee.entitled_2025;
            const total_2025 = entitled_2025 + previous;
            const remaining = total_2025 - regularDays;

            document.getElementById("entitled").textContent = entitled_2025;
            document.getElementById("total").textContent = total_2025;
            document.getElementById("remaining").textContent = remaining;

            const { error } = await supabase
                .from("employees")
                .update({
                    previous: previous,
                    total_2025: total_2025,
                    remaining: remaining
                })
                .eq("id", selectedEmployee.id);
            if (error) {
                console.error("Error updating employee totals:", error);
            } else {
                selectedEmployee.previous = previous;
                selectedEmployee.total_2025 = total_2025;
                selectedEmployee.remaining = remaining;
            }
        }

        function renderLeaveTable() {
            const tbody = document.getElementById("leaveTableBody");
            tbody.innerHTML = "";
            leaves.forEach((leave, index) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><input type="date" value="${leave.from_date}" ${leave.saved ? 'disabled' : ''} onchange="calculateDays(this, ${index})"></td>
                    <td><input type="date" value="${leave.to_date}" ${leave.saved ? 'disabled' : ''} onchange="calculateDays(this, ${index})"></td>
                    <td><span class="days">${leave.days}</span></td>
                    <td><input type="radio" name="leave${index}" value="regular" ${leave.regular ? "checked" : ""} ${leave.saved ? 'disabled' : ''} onchange="updateLeave(${index})"></td>
                    <td><input type="radio" name="leave${index}" value="sick" ${leave.sick ? "checked" : ""} ${leave.saved ? 'disabled' : ''} onchange="updateLeave(${index})"></td>
                    <td><input type="radio" name="leave${index}" value="parental" ${leave.parental ? "checked" : ""} ${leave.saved ? 'disabled' : ''} onchange="updateLeave(${index})"></td>
                    <td><input type="radio" name="leave${index}" value="educational" ${leave.educational ? "checked" : ""} ${leave.saved ? 'disabled' : ''} onchange="updateLeave(${index})"></td>
                    <td><input type="radio" name="leave${index}" value="special" ${leave.special ? "checked" : ""} ${leave.saved ? 'disabled' : ''} onchange="updateLeave(${index})"></td>
                    <td><input type="radio" name="leave${index}" value="blood_donation" ${leave.blood_donation ? "checked" : ""} ${leave.saved ? 'disabled' : ''} onchange="updateLeave(${index})"></td>
                    <td><input type="radio" name="leave${index}" value="day_off" ${leave.day_off ? "checked" : ""} ${leave.saved ? 'disabled' : ''} onchange="updateLeave(${index})"></td>
                    <td><input type="radio" name="leave${index}" value="other" ${leave.other ? "checked" : ""} ${leave.saved ? 'disabled' : ''} onchange="updateLeave(${index})"></td>
                    <td class="leave-actions">
                        <button onclick="saveLeave(${index})" ${leave.saved ? 'disabled' : ''}>Save</button>
                        <button onclick="deleteLeave(${index})">Delete</button>
                    </td>
                    <td></td><td></td><td></td>
                `;
                tbody.appendChild(row);
            });
        }

        function printLeaves() {
            window.print();
        }

        function generateReport() {
            let totalDays = 0, regularDays = 0, sickDays = 0, parentalDays = 0, educationalDays = 0, specialDays = 0, bloodDonationDays = 0, dayOffDays = 0, otherDays = 0;

            leaves.forEach(leave => {
                if (leave.saved) {
                    totalDays += leave.days;
                    if (leave.regular) regularDays += leave.days;
                    if (leave.sick) sickDays += leave.days;
                    if (leave.parental) parentalDays += leave.days;
                    if (leave.educational) educationalDays += leave.days;
                    if (leave.special) specialDays += leave.days;
                    if (leave.blood_donation) bloodDonationDays += leave.days;
                    if (leave.day_off) dayOffDays += leave.days;
                    if (leave.other) otherDays += leave.days;
                }
            });

            document.getElementById("reportYear").textContent = currentYear;
            document.getElementById("totalLeaveDays").textContent = totalDays;
            document.getElementById("regularDays").textContent = regularDays;
            document.getElementById("sickDays").textContent = sickDays;
            document.getElementById("parentalDays").textContent = parentalDays;
            document.getElementById("educationalDays").textContent = educationalDays;
            document.getElementById("specialDays").textContent = specialDays;
            document.getElementById("bloodDonationDays").textContent = bloodDonationDays;
            document.getElementById("dayOffDays").textContent = dayOffDays;
            document.getElementById("otherDays").textContent = otherDays;

            document.getElementById("leaveReport").style.display = "block";
        }
    </script>
</body>
</html>
