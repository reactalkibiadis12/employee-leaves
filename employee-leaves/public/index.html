<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Διαχείριση Αδειών Εργαζομένων</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="icon" type="image/png" href="icon.png">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
        zoom: 80%;
        background-color: #f4f7fa;
        color: #333;
        padding: 20px;
        line-height: 1.6;
    }

    h1, h2, h3 {
        color: #2c3e50;
        margin-bottom: 20px;
    }

    .container {
        width: 100%;
        padding: 20px;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .login-container {
        max-width: 400px;
        margin: 100px auto;
        padding: 20px;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        text-align: center;
    }

    .login-container input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
    }

    .login-container button, .logout-btn {
        background-color: #3498db;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .logout-btn {
        position: absolute;
        top: 20px;
        right: 20px;
    }

    .login-container button:hover, .logout-btn:hover {
        background-color: #2980b9;
    }

    .dropdown {
        margin-bottom: 20px;
    }

    .dropdown button, .form-container button, .edit-form button, .details button {
        background-color: #3498db;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.1s;
    }

    .dropdown button:hover, .form-container button:hover, .edit-form button:hover, .details button:hover {
        background-color: #2980b9;
        transform: translateY(-2px);
    }

    .employee-search {
        margin-bottom: 15px;
    }

    .employee-search input {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #fff;
        transition: border-color 0.3s;
    }

    .employee-search input:focus {
        border-color: #3498db;
        outline: none;
        box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
    }

    .employee-dropdown {
        position: relative;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .employee-dropdown select {
        flex: 1;
        padding: 12px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #fff;
        cursor: pointer;
        appearance: none;
        background-image: url('data:image/svg+xml;utf8,<svg fill="gray" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 10px center;
        transition: border-color 0.3s;
    }

    .employee-dropdown select:focus {
        border-color: #3498db;
        outline: none;
        box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
    }

    .year-selector {
        margin-bottom: 15px;
    }

    .year-selector select {
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
    }

    .employee-actions {
        display: none;
        gap: 10px;
    }

    .employee-actions button {
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .employee-actions button.edit {
        background-color: #f39c12;
    }

    .employee-actions button.edit:hover {
        background-color: #e67e22;
    }

    .employee-actions button.delete {
        background-color: #e74c3c;
    }

    .employee-actions button.delete:hover {
        background-color: #c0392b;
    }

    .form-container, .edit-form {
        margin-bottom: 20px;
        display: none;
        padding: 20px;
        background: #f9f9f9;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .form-container input, .edit-form input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
        transition: border-color 0.3s;
    }

    .form-container input:focus, .edit-form input:focus {
        border-color: #3498db;
        outline: none;
    }

    .form-container .children-section, .edit-form .children-section {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .form-container .children-section select, .edit-form .children-section select {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
    }

    #differentLevels, #editDifferentLevels {
        display: none;
    }

    .details {
        display: none;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: #fff;
        border-radius: 8px;
        overflow-x: auto;
        color: #000; /* Μαύρο χρώμα για όλο τον πίνακα */
    }

    th, td {
        border: 2px solid #000; /* Πιο σκούρα και χοντρά περιγράμματα */
        padding: 12px;
        text-align: center;
        white-space: nowrap;
        color: #000; /* Μαύρο χρώμα για το κείμενο */
    }

    th {
        background-color: #3498db;
        color: #fff; /* Τα headers παραμένουν λευκά για αντίθεση */
        font-weight: 600;
    }

    tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    tr:hover {
        background-color: #f1f1f1;
    }

    /* Στυλ για τα checkboxes - Επιλογή 1: Μεγάλη κουκίδα στο κέντρο */
    input[type="radio"] {
        appearance: none;
        width: 16px;
        height: 16px;
        border: 2px solid #000; /* Μαύρο περίγραμμα για τα checkboxes */
        border-radius: 50%;
        background-color: #fff;
        cursor: pointer;
        vertical-align: middle;
        position: relative;
    }

    input[type="radio"]:checked::before {
        content: "●"; /* Μεγάλη μαύρη κουκίδα */
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 14px; /* Μεγαλύτερο μέγεθος κουκίδας */
        color: #000; /* Μαύρο χρώμα */
    }

    /* Εναλλακτική Επιλογή 2: Πλήρως γεμισμένο checkbox (σχολιασμένο - ξεσχολίασε το αν το προτιμάς) */
    /*
    input[type="radio"]:checked {
        background-color: #000; 
        border: 2px solid #000;
    }
    */

    /* Στυλ για τις ημερομηνίες (inputs μέσα στον πίνακα) */
    .flatpickr input[type="text"],
    td input[type="text"] {
        color: #000 !important; /* Μαύρο χρώμα για τις ημερομηνίες */
        font-weight: bold; /* Πιο έντονο για καλύτερη αναγνωσιμότητα */
        border: 2px solid #000; /* Μαύρο περίγραμμα */
    }

    .leave-actions button {
        padding: 8px 12px;
        margin: 0 5px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .leave-actions button:first-child {
        background-color: #2ecc71;
    }

    .leave-actions button:first-child:hover {
        background-color: #27ae60;
    }

    .leave-actions button:last-child {
        background-color: #e74c3c;
    }

    .leave-actions button:last-child:hover {
        background-color: #c0392b;
    }

    .summary-container {
        display: flex;
        justify-content: space-between;
        gap: 20px;
    }

    .summary-column {
        flex: 1;
    }

    .summary label {
        font-weight: 500;
        margin: 5px 0;
        display: block;
    }

    .summary input[type="number"] {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 5px;
        width: 100px;
    }

    .report {
        padding: 20px;
        background: #f9f9f9;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .report p {
        margin: 5px 0;
    }

    .modern-button {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        margin: 5px;
    }

    .modern-button.add-leave {
        background: linear-gradient(45deg, #ff6f61, #ff9f80);
    }

    .modern-button.add-leave:hover {
        background: linear-gradient(45deg, #ff9f80, #ff6f61);
        transform: translateY(-2px);
    }

    .modern-button.print-leaves {
        background: linear-gradient(45deg, #40c4ff, #0288d1);
    }

    .modern-button.print-leaves:hover {
        background: linear-gradient(45deg, #0288d1, #40c4ff);
        transform: translateY(-2px);
    }

    .parental-hours-input {
        display: none;
        width: 60px;
        padding: 5px;
        margin-left: 5px;
    }

    .reason-input, .protocol-input {
        width: 100%;
        padding: 5px;
        resize: vertical;
        min-height: 20px;
        overflow: hidden;
        box-sizing: border-box;
    }

    .reason-input {
        max-length: 50;
    }

    .holiday-warning {
        color: red;
        font-size: 12px;
        display: none;
        margin-top: 2px;
    }

    .holiday-warning.weekend {
        color: #ff9800;
    }

    .flatpickr-day.holiday {
        background: #ff3333;
        color: white;
        border-radius: 50%;
    }

    .flatpickr-day.holiday:hover {
        background: #e60000;
    }

    .cancel-btn {
        background-color: #e74c3c;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        margin-right: 5px;
    }

    .cancel-btn:hover {
        background-color: #c0392b;
    }

    @media print {
        body {
            visibility: hidden;
            margin: 0;
            padding: 0;
        }
        #employeeDetails, #employeeDetails * {
            visibility: visible;
        }
        h1, .dropdown, #addEmployeeForm, .employee-search, .employee-dropdown, .edit-form, .logout-btn {
            display: none !important;
        }
        #employeeDetails {
            position: relative;
            padding: 0;
            box-shadow: none !important; /* Αφαίρεση σκιάς στην εκτύπωση */
        }
        #employeeName {
            margin-top: 0;
        }
        #leaveTable {
            position: relative;
            width: 100%;
            margin-bottom: 20px;
            page-break-inside: auto;
        }
        #leaveTable tr {
            page-break-inside: avoid;
            page-break-after: auto;
        }
        .report {
            position: relative;
            width: 100%;
            page-break-before: auto;
        }
        .modern-button {
            display: none;
        }
        @page {
            size: landscape;
            margin: 10mm;
        }
        body {
            visibility: visible;
            width: 100%;
        }
        /* Ειδικές ρυθμίσεις για τον πίνακα στην εκτύπωση */
        table {
            color: #000 !important; /* Εξασφαλίζει μαύρο χρώμα στην εκτύπωση */
        }
        th, td {
            border: 2px solid #000 !important; /* Πιο σκούρα περιγράμματα στην εκτύπωση */
            color: #000 !important;
        }
        input[type="radio"] {
            border: 2px solid #000 !important;
            -webkit-print-color-adjust: exact; /* Εξασφαλίζει σωστή απόδοση χρώματος */
        }
        /* Επιλογή 1: Μεγάλη κουκίδα στο κέντρο */
        input[type="radio"]:checked::before {
            content: "●"; /* Μεγάλη μαύρη κουκίδα */
            color: #000 !important;
            font-size: 14px; /* Μεγαλύτερο μέγεθος */
            -webkit-print-color-adjust: exact;
        }
        /* Εναλλακτική Επιλογή 2: Πλήρως γεμισμένο checkbox (σχολιασμένο - ξεσχολίασε το αν το προτιμάς) */
        /*
        input[type="radio"]:checked {
            background-color: #000 !important;
            border: 2px solid #000 !important;
            -webkit-print-color-adjust: exact;
        }
        */
        .flatpickr input[type="text"],
        td input[type="text"] {
            color: #000 !important;
            border: 2px solid #000 !important;
            -webkit-print-color-adjust: exact; /* Εξασφαλίζει σωστή απόδοση χρώματος */
        }
        tr:nth-child(even) {
            background-color: #fff !important; /* Αφαιρεί το γκρι φόντο στην εκτύπωση */
        }
        tr:hover {
            background-color: #fff !important; /* Αφαιρεί το hover effect */
        }
    }
</style>
</head>
<body>
    <div id="loginContainer" class="login-container">
        <h2>Σύνδεση Διαχειριστή</h2>
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Κωδικός">
        <button onclick="login()">Σύνδεση</button>
        <p id="loginError" style="color: red; display: none;"></p>
    </div>

    <div id="mainContainer" class="container" style="display: none;">
        <button class="logout-btn" onclick="logout()">Αποσύνδεση</button>
        <h1>Διαχείριση Αδειών Εργαζομένων</h1>
        <div class="dropdown">
            <button onclick="toggleForm()">Προσθήκη Εργαζομένου ▼</button>
        </div>
        <div class="form-container" id="addEmployeeForm">
            <h3>Προσθήκη Νέου Εργαζομένου</h3>
            <input type="text" id="surname" placeholder="Επώνυμο"><br>
            <input type="text" id="name" placeholder="Όνομα"><br>
            <input type="text" id="afm" placeholder="ΑΦΜ"><br>
            <input type="email" id="email" placeholder="Email"><br>
            <input type="text" id="phone" placeholder="Τηλέφωνο"><br>
            <div class="children-section">
                <input type="number" id="numberOfChildren" placeholder="Αριθμός Παιδιών" min="0" oninput="toggleDifferentLevels()">
                <div id="differentLevels">
                    <label>Διαφορετικές Εκπαιδευτικές Βαθμίδες:</label>
                    <select id="differentLevelsSelect">
                        <option value="false">ΟΧΙ</option>
                        <option value="true">ΝΑΙ</option>
                    </select>
                </div>
            </div>
            <button onclick="addEmployee()">Προσθήκη</button>
        </div>

        <div class="employee-search">
            <input type="text" id="employeeSearch" placeholder="Αναζήτηση Εργαζομένου (Επώνυμο ή Όνομα)" onkeyup="filterEmployees()">
        </div>

        <div class="employee-dropdown" id="employeeDropdown">
            <select id="employeeSelect" onchange="showDetails(this.value)">
                <option value="">Επιλέξτε Εργαζόμενο</option>
            </select>
            <div class="employee-actions" id="employeeActions">
                <button class="edit" onclick="editEmployee(selectedEmployee.id)">Επεξεργασία</button>
                <button class="delete" onclick="deleteEmployee(selectedEmployee.id)">Διαγραφή</button>
            </div>
        </div>

        <div class="edit-form" id="editForm">
            <h3>Επεξεργασία Εργαζομένου</h3>
            <input type="text" id="editSurname" placeholder="Επώνυμο"><br>
            <input type="text" id="editName" placeholder="Όνομα"><br>
            <input type="text" id="editAfm" placeholder="ΑΦΜ"><br>
            <input type="email" id="editEmail" placeholder="Email"><br>
            <input type="text" id="editPhone" placeholder="Τηλέφωνο"><br>
            <div class="children-section">
                <input type="number" id="editNumberOfChildren" placeholder="Αριθμός Παιδιών" min="0" oninput="toggleEditDifferentLevels()">
                <div id="editDifferentLevels">
                    <label>Διαφορετικές Εκπαιδευτικές Βαθμίδες:</label>
                    <select id="editDifferentLevelsSelect">
                        <option value="false">ΟΧΙ</option>
                        <option value="true">ΝΑΙ</option>
                    </select>
                </div>
            </div>
            <button onclick="saveEdit()">Αποθήκευση</button>
            <button onclick="cancelEdit()">Ακύρωση</button>
        </div>

        <div class="details" id="employeeDetails">
            <h2 id="employeeName"></h2>
            <div class="summary-container">
                <div class="summary-column summary">
    <label>Δικαιούται <span id="currentYearEntitled"></span>: <span id="entitled"></span></label>
    <label>Υπόλοιπα προηγούμενου έτους: <input type="number" id="previous" min="0" onchange="updateTotals()"></label>
    <label>Σύνολα <span id="currentYearTotal"></span>: <span id="total"></span></label>
    <label>Υπόλοιπα: <span id="remaining"></span></label>
    <label>Συνολικές ώρες γονικής άδειας: <span id="totalParentalHours"></span></label>
    <label>Υπόλοιπες ώρες γονικής άδειας: <span id="remainingParentalHours"></span></label>
    <label>Σύνολο Αιμοδοσίας: <span id="totalBloodDonationDays"></span></label>
    <label>Υπόλοιπα Αιμοδοσίας: <span id="remainingBloodDonationDays"></span></label>
    <label>Σύνολο Υ.Δ: <span id="totalSpecialDays"></span></label>
    <label>Υπόλοιπα Υ.Δ: <span id="remainingSpecialDays"></span></label>
    <label>Σύνολο Αναρρωτικών: <input type="number" id="totalSickDays" min="0" onchange="updateTotals()"></label>
    <label>Υπόλοιπα Αναρρωτικών: <span id="remainingSickDays"></span></label>
    <label>Σύνολο Άλλων Αδειών: <input type="number" id="totalOtherDays" min="0" onchange="updateTotals()"></label>
    <label>Υπόλοιπα Άλλων Αδειών: <span id="remainingOtherDays"></span></label>
</div>
                <div class="summary-column report" id="leaveReport">
                    <h3>Σύνολο Αδειών <span id="reportYear"></span></h3>
                    <p>Σύνολο Ημερών Αδειών: <span id="totalLeaveDays"></span></p>
                    <p>Κανονική: <span id="regularDays"></span></p>
                    <p>Αναρρωτική: <span id="sickDays"></span></p>
                    <p>Γονική: <span id="parentalDays"></span> (Ώρες: <span id="parentalHours"></span>)</p>
                    <p>Εκπαιδευτική: <span id="educationalDays"></span></p>
                    <p>Υ.Δ: <span id="specialDays"></span></p>
                    <p>Αιμοδοσία: <span id="bloodDonationDays"></span></p>
                    <p>Ρεπό: <span id="dayOffDays"></span></p>
                    <p>Άλλη: <span id="otherDays"></span></p>
                </div>
            </div>
            <div class="year-selector">
                <label>Επιλογή Έτους: </label>
                <select id="yearSelect" onchange="updateLeaveTableForYear(this.value)">
                    <!-- Θα γεμίσει δυναμικά -->
                </select>
            </div>
            <table id="leaveTable">
                <thead>
                    <tr>
                        <th>Α/Α</th>
                        <th>ΑΠΟ</th>
                        <th>ΕΩΣ</th>
                        <th>ΜΕΡΕΣ</th>
                        <th>ΑΡ. ΠΡΩΤ.</th>
                        <th>ΚΑΝΟΝΙΚΗ</th>
                        <th>ΑΝΑΡ/ΚΗ</th>
                        <th>ΓΟΝΙΚΗ</th>
                        <th>ΕΚΠ/ΚΗ</th>
                        <th>Υ.Δ</th>
                        <th>ΑΙΜΟΔΟΣΙΑ</th>
                        <th>ΡΕΠΟ</th>
                        <th>ΑΛΛΗ</th>
                        <th>ΑΙΤΙΟΛΟΓΙΑ</th>
                        <th>ΕΝΕΡΓΕΙΕΣ</th>
                        <th>ΥΠΑΛΛΗΛΟΣ</th>
                        <th>ΤΜΗΜΑΤΑΡΧΗΣ</th>
                        <th>ΠΡΟΪΣΤΑΜΕΝΟΣ</th>
                    </tr>
                </thead>
                <tbody id="leaveTableBody"></tbody>
            </table>
            <button class="modern-button add-leave" onclick="addLeaveRow()">Προσθήκη Άδειας</button>
            <button class="modern-button print-leaves" onclick="printLeaves()">Εκτύπωση Αδειών</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/el.js"></script>
    <script>
        const supabaseUrl = "https://nsrksmlqruogmckxpqer.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zcmtzbWxxcnVvZ21ja3hwcWVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE3NjYwNjQsImV4cCI6MjA1NzM0MjA2NH0.NydawPjtyBG83qH79uY6rWqCFZleJ6zfo-ZgkRw5QoY";
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let selectedEmployee = null;
        let leaves = [];
        let editingEmployee = null;
        let allEmployees = [];
        let currentYear = new Date().getFullYear();
        let selectedYear = currentYear;
        const adminEmails = ["themspyr@gmail.com", "papape@eedpmt.ypen.gr"];
        let greekHolidays = {};

        const TOTAL_BLOOD_DONATION_DAYS = 6;
        const TOTAL_SPECIAL_DAYS = 2;
        const DEFAULT_ENTITLED_DAYS = 25;
        const DEFAULT_SICK_DAYS = 6;
        const DEFAULT_OTHER_DAYS = 5;

        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                const user = session.user;
                if (adminEmails.includes(user.email)) {
                    document.getElementById("loginContainer").style.display = "none";
                    document.getElementById("mainContainer").style.display = "block";
                    await checkAndUpdateYear();
                    loadEmployees();
                } else {
                    alert("Μόνο ο διαχειριστής μπορεί να έχει πρόσβαση!");
                    logout();
                }
            } else {
                document.getElementById("loginContainer").style.display = "block";
                document.getElementById("mainContainer").style.display = "none";
            }
        }

async function checkAndUpdateYear() {
    const storedYear = localStorage.getItem("lastCheckedYear");
    const newYear = new Date().getFullYear();

    if (storedYear && parseInt(storedYear) !== newYear) {
        const { data: employees, error: empError } = await supabase.from("employees").select("*");
        if (empError) {
            console.error("Error fetching employees for year update:", empError);
            return;
        }

        for (const emp of employees) {
            const { error: updateError } = await supabase
                .from("employees")
                .update({
                    previous: emp.remaining,
                    entitled: DEFAULT_ENTITLED_DAYS,
                    total: DEFAULT_ENTITLED_DAYS + emp.remaining,
                    remaining: DEFAULT_ENTITLED_DAYS + emp.remaining,
                    total_sick_days: DEFAULT_SICK_DAYS,
                    total_other_days: DEFAULT_OTHER_DAYS
                })
                .eq("id", emp.id);

            if (updateError) {
                console.error(`Error updating employee ${emp.id}:`, updateError);
            }
        }

        localStorage.setItem("lastCheckedYear", newYear.toString());
        currentYear = newYear;
        selectedYear = newYear;
    } else if (!storedYear) {
        localStorage.setItem("lastCheckedYear", currentYear.toString());
    }
}

        async function login() {
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;
            const errorMsg = document.getElementById("loginError");

            if (!email || !password) {
                errorMsg.textContent = "Παρακαλώ συμπληρώστε όλα τα πεδία!";
                errorMsg.style.display = "block";
                return;
            }

            const { error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) {
                errorMsg.textContent = "Λάθος email ή κωδικός!";
                errorMsg.style.display = "block";
                return;
            }

            if (!adminEmails.includes(email)) {
                errorMsg.textContent = "Μόνο ο διαχειριστής μπορεί να συνδεθεί!";
                errorMsg.style.display = "block";
                await supabase.auth.signOut();
                return;
            }

            document.getElementById("loginContainer").style.display = "none";
            document.getElementById("mainContainer").style.display = "block";
            await checkAndUpdateYear();
            loadEmployees();
        }

        async function logout() {
            await supabase.auth.signOut();
            document.getElementById("loginContainer").style.display = "block";
            document.getElementById("mainContainer").style.display = "none";
            document.getElementById("loginEmail").value = "";
            document.getElementById("loginPassword").value = "";
            document.getElementById("loginError").style.display = "none";
        }

        checkAuth();

        function toggleForm() {
            const form = document.getElementById("addEmployeeForm");
            form.style.display = form.style.display === "block" ? "none" : "block";
        }

        function toggleDifferentLevels() {
            const numChildren = parseInt(document.getElementById("numberOfChildren").value) || 0;
            const differentLevels = document.getElementById("differentLevels");
            differentLevels.style.display = numChildren >= 2 ? "block" : "none";
            if (numChildren < 2) {
                document.getElementById("differentLevelsSelect").value = "false";
            }
        }

        function toggleEditDifferentLevels() {
            const numChildren = parseInt(document.getElementById("editNumberOfChildren").value) || 0;
            const differentLevels = document.getElementById("editDifferentLevels");
            differentLevels.style.display = numChildren >= 2 ? "block" : "none";
            if (numChildren < 2) {
                document.getElementById("editDifferentLevelsSelect").value = "false";
            }
        }

        async function loadEmployees() {
    const { data, error } = await supabase
        .from("employees")
        .select("*");

    if (error) {
        console.error("Error loading employees:", error);
        return;
    }

    allEmployees = data;
    renderEmployees(data);
    if (selectedEmployee) {
        selectedEmployee = allEmployees.find(emp => emp.id === selectedEmployee.id);
        // Ενημερώνουμε τα πεδία στο UI με τις τιμές από τη βάση
        document.getElementById("totalSickDays").textContent = selectedEmployee.total_sick_days || 0;
        document.getElementById("totalOtherDays").textContent = selectedEmployee.total_other_days || 0;
        await updateTotals(); // Υπολογίζει τα υπόλοιπα με βάση τις άδειες
    }
}

        function renderEmployees(employees) {
            const dropdown = document.querySelector("#employeeSelect");
            dropdown.innerHTML = '<option value="">Επιλέξτε Εργαζόμενο</option>';
            employees.forEach((emp) => {
                const option = document.createElement("option");
                option.value = emp.id;
                option.textContent = `${emp.surname} ${emp.name} | ${emp.afm} | ${emp.email}`;
                dropdown.appendChild(option);
            });
        }

        function filterEmployees() {
            const searchTerm = document.getElementById("employeeSearch").value.toLowerCase();
            const filteredEmployees = allEmployees.filter(emp =>
                emp.surname.toLowerCase().includes(searchTerm) ||
                emp.name.toLowerCase().includes(searchTerm)
            );
            renderEmployees(filteredEmployees);
        }

     async function addEmployee() {
    const surname = document.getElementById("surname").value;
    const name = document.getElementById("name").value;
    const afm = document.getElementById("afm").value;
    const email = document.getElementById("email").value;
    const phone = document.getElementById("phone").value || null;
    const numberOfChildren = parseInt(document.getElementById("numberOfChildren").value) || 0;
    const differentLevels = document.getElementById("differentLevelsSelect").value === "true";

    if (surname && name && afm && email) {
        const { error } = await supabase.from("employees").insert({
            surname,
            name,
            afm,
            email,
            phone,
            previous: 0,
            entitled: DEFAULT_ENTITLED_DAYS,
            total: DEFAULT_ENTITLED_DAYS,
            remaining: DEFAULT_ENTITLED_DAYS,
            number_of_children: numberOfChildren,
            different_educational_levels: differentLevels,
            total_sick_days: DEFAULT_SICK_DAYS, // Default τιμή
            total_other_days: DEFAULT_OTHER_DAYS // Default τιμή
        });
        if (error) {
            console.error("Error adding employee:", error);
            return;
        }
        loadEmployees();
        document.getElementById("surname").value = "";
        document.getElementById("name").value = "";
        document.getElementById("afm").value = "";
        document.getElementById("email").value = "";
        document.getElementById("phone").value = "";
        document.getElementById("numberOfChildren").value = "";
        document.getElementById("differentLevelsSelect").value = "false";
        toggleDifferentLevels();
        toggleForm();
    } else {
        alert("Συμπληρώστε όλα τα υποχρεωτικά πεδία (Επώνυμο, Όνομα, ΑΦΜ, Email)!");
    }
}

        async function deleteEmployee(id) {
            if (confirm("Είστε σίγουροι ότι θέλετε να διαγράψετε αυτόν τον εργαζόμενο;")) {
                const { error: leavesError } = await supabase
                    .from("leaves")
                    .delete()
                    .eq("employee_id", id);
                if (leavesError) {
                    console.error("Error deleting leaves:", leavesError);
                    return;
                }
                const { error } = await supabase
                    .from("employees")
                    .delete()
                    .eq("id", id);
                if (error) {
                    console.error("Error deleting employee:", error);
                    return;
                }
                loadEmployees();
                document.getElementById("employeeSelect").value = "";
                document.getElementById("employeeActions").style.display = "none";
                if (selectedEmployee && selectedEmployee.id === id) {
                    document.getElementById("employeeDetails").style.display = "none";
                    selectedEmployee = null;
                }
                if (editingEmployee && editingEmployee.id === id) {
                    document.getElementById("editForm").style.display = "none";
                    editingEmployee = null;
                }
            }
        }

        async function editEmployee(id) {
            const { data, error } = await supabase
                .from("employees")
                .select("*")
                .eq("id", id)
                .single();
            if (error) {
                console.error("Error fetching employee for edit:", error);
                return;
            }
            editingEmployee = data;
            document.getElementById("editSurname").value = data.surname;
            document.getElementById("editName").value = data.name;
            document.getElementById("editAfm").value = data.afm;
            document.getElementById("editEmail").value = data.email;
            document.getElementById("editPhone").value = data.phone || "";
            document.getElementById("editNumberOfChildren").value = data.number_of_children || 0;
            document.getElementById("editDifferentLevelsSelect").value = data.different_educational_levels ? "true" : "false";
            toggleEditDifferentLevels();
            document.getElementById("editForm").style.display = "block";
            document.getElementById("employeeDropdown").style.display = "none";
        }

        async function saveEdit() {
            const surname = document.getElementById("editSurname").value;
            const name = document.getElementById("editName").value;
            const afm = document.getElementById("editAfm").value;
            const email = document.getElementById("editEmail").value;
            const phone = document.getElementById("editPhone").value || null;
            const numberOfChildren = parseInt(document.getElementById("editNumberOfChildren").value) || 0;
            const differentLevels = document.getElementById("editDifferentLevelsSelect").value === "true";

            if (surname && name && afm && email) {
                const { error } = await supabase
                    .from("employees")
                    .update({
                        surname,
                        name,
                        afm,
                        email,
                        phone,
                        number_of_children: numberOfChildren,
                        different_educational_levels: differentLevels
                    })
                    .eq("id", editingEmployee.id);
                if (error) {
                    console.error("Error updating employee:", error);
                    return;
                }
                loadEmployees();
                document.getElementById("editForm").style.display = "none";
                document.getElementById("employeeDropdown").style.display = "flex";
                if (selectedEmployee && selectedEmployee.id === editingEmployee.id) {
                    selectedEmployee = { ...selectedEmployee, surname, name, afm, email, phone, number_of_children: numberOfChildren, different_educational_levels: differentLevels };
                    updateEmployeeDetailsDisplay();
                    document.getElementById("employeeSelect").value = editingEmployee.id;
                    updateTotals();
                }
                editingEmployee = null;
            } else {
                alert("Συμπληρώστε όλα τα υποχρεωτικά πεδία (Επώνυμο, Όνομα, ΑΦΜ, Email)!");
            }
        }

        function cancelEdit() {
            document.getElementById("editForm").style.display = "none";
            document.getElementById("employeeDropdown").style.display = "flex";
            editingEmployee = null;
        }

        function calculateTotalParentalHours(employee) {
            const numChildren = employee.number_of_children || 0;
            const differentLevels = employee.different_educational_levels || false;

            if (numChildren === 1) return 32;
            if (numChildren >= 2 && !differentLevels) return 40;
            if (numChildren >= 2 && differentLevels) return 48;
            return 0;
        }

        function updateEmployeeDetailsDisplay() {
            let displayText = `${selectedEmployee.surname} ${selectedEmployee.name} | ${selectedEmployee.afm} | ${selectedEmployee.email}`;
            if (selectedEmployee.phone) displayText += ` | Τηλ: ${selectedEmployee.phone}`;
            if (selectedEmployee.number_of_children > 0) displayText += ` | ${selectedEmployee.number_of_children} ανήλικα παιδιά`;
            if (selectedEmployee.number_of_children >= 2) displayText += ` | Διαφορετική βαθμίδα παιδιών: ${selectedEmployee.different_educational_levels ? "Ναι" : "Όχι"}`;
            document.getElementById("employeeName").textContent = displayText;
        }

       async function showDetails(id) {
    const actions = document.getElementById("employeeActions");
    if (!id) {
        document.getElementById("employeeDetails").style.display = "none";
        actions.style.display = "none";
        selectedEmployee = null;
        return;
    }
    const { data, error } = await supabase
        .from("employees")
        .select("*")
        .eq("id", id)
        .single();
    if (error) {
        console.error("Error loading employee details:", error);
        return;
    }
    selectedEmployee = data;
    document.getElementById("employeeDetails").style.display = "block";
    actions.style.display = "flex";
    updateEmployeeDetailsDisplay();
    document.getElementById("previous").value = data.previous || 0;
    document.getElementById("entitled").textContent = data.entitled;
    document.getElementById("total").textContent = data.total;
    document.getElementById("remaining").textContent = data.remaining;
    document.getElementById("currentYearEntitled").textContent = currentYear;
    document.getElementById("currentYearTotal").textContent = currentYear;

    const totalParentalHours = calculateTotalParentalHours(data);
    document.getElementById("totalParentalHours").textContent = totalParentalHours;
    document.getElementById("totalBloodDonationDays").textContent = TOTAL_BLOOD_DONATION_DAYS;
    document.getElementById("totalSpecialDays").textContent = TOTAL_SPECIAL_DAYS;
    document.getElementById("totalSickDays").value = data.total_sick_days || DEFAULT_SICK_DAYS; // Default τιμή αν δεν υπάρχει
    document.getElementById("totalOtherDays").value = data.total_other_days || DEFAULT_OTHER_DAYS; // Default τιμή αν δεν υπάρχει

    const { data: leavesData, error: leavesError } = await supabase
        .from("leaves")
        .select("*")
        .eq("employee_id", data.id);
    if (leavesError) {
        console.error("Error loading leaves:", leavesError);
        return;
    }
    leaves = leavesData.map(leave => ({ ...leave, saved: true }));
    console.log("Loaded leaves:", leaves);

    const years = [...new Set(leaves.map(leave => new Date(leave.from_date).getFullYear()))];
    const currentYearNow = new Date().getFullYear();
    if (!years.includes(currentYearNow)) years.push(currentYearNow);
    if (!years.includes(currentYearNow + 1)) years.push(currentYearNow + 1);
    years.sort((a, b) => b - a);

    for (const year of years) {
        if (!greekHolidays[year]) {
            greekHolidays[year] = await getGreekHolidays(year);
        }
    }

    const yearSelect = document.getElementById("yearSelect");
    yearSelect.innerHTML = "";
    years.forEach(year => {
        const option = document.createElement("option");
        option.value = year;
        option.textContent = year;
        if (year === currentYear) option.selected = true;
        yearSelect.appendChild(option);
    });

    selectedYear = currentYear;
    updateLeaveTableForYear(selectedYear);
    updateTotals();
}

        function updateLeaveTableForYear(year) {
            selectedYear = parseInt(year);
            renderLeaveTable();
            updateTotals();
            const addLeaveButton = document.querySelector(".add-leave");
            addLeaveButton.disabled = selectedYear !== currentYear;
        }

        async function getGreekHolidays(year) {
            const response = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/GR`);
            const holidays = await response.json();
            console.log(`Holidays for ${year}:`, holidays.map(h => h.date));
            return holidays.map(h => h.date);
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = "auto";
            textarea.style.height = textarea.scrollHeight + "px";
        }

        function addLeaveRow() {
            if (selectedYear !== currentYear) {
                alert("Μπορείτε να προσθέσετε άδειες μόνο για το τρέχον έτος!");
                return;
            }
            const tbody = document.getElementById("leaveTableBody");
            const rowIndex = leaves.filter(leave => new Date(leave.from_date).getFullYear() === selectedYear).length;
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${rowIndex + 1}</td>
                <td><input type="text" class="flatpickr" id="fromDate${rowIndex}" onchange="calculateDays(this, ${rowIndex})"><span class="holiday-warning" id="rangeHolidayWarning${rowIndex}"></span></td>
                <td><input type="text" class="flatpickr" id="toDate${rowIndex}" onchange="calculateDays(this, ${rowIndex})"></td>
                <td><span class="days">0</span></td>
                <td><textarea class="protocol-input" id="protocolNumber${rowIndex}" placeholder="Αρ. Πρωτ. (προαιρετικό)" oninput="autoResizeTextarea(this)"></textarea></td>
                <td><input type="radio" name="leave${rowIndex}" value="regular" onchange="updateLeave(${rowIndex})"></td>
                <td><input type="radio" name="leave${rowIndex}" value="sick" onchange="updateLeave(${rowIndex})"></td>
                <td><input type="radio" name="leave${rowIndex}" value="parental" onchange="updateLeave(${rowIndex})"><input type="number" class="parental-hours-input" id="parentalHours${rowIndex}" placeholder="Ώρες" min="0"></td>
                <td><input type="radio" name="leave${rowIndex}" value="educational" onchange="updateLeave(${rowIndex})"></td>
                <td><input type="radio" name="leave${rowIndex}" value="special" onchange="updateLeave(${rowIndex})"></td>
                <td><input type="radio" name="leave${rowIndex}" value="blood_donation" onchange="updateLeave(${rowIndex})"></td>
                <td><input type="radio" name="leave${rowIndex}" value="day_off" onchange="updateLeave(${rowIndex})"></td>
                <td><input type="radio" name="leave${rowIndex}" value="other" onchange="updateLeave(${rowIndex})"></td>
                <td><textarea class="reason-input" id="reason${rowIndex}" maxlength="50" placeholder="Αιτιολογία (προαιρετικό, max 50)" oninput="autoResizeTextarea(this)"></textarea></td>
                <td class="leave-actions">
                    <button class="cancel-btn" onclick="cancelLeaveRow(${rowIndex})">X</button>
                    <button onclick="saveLeave(${rowIndex})">Αποθήκευση</button>
                </td>
                <td></td><td></td><td></td>
            `;
            tbody.appendChild(row);
            leaves.push({
                employee_id: selectedEmployee.id,
                from_date: "",
                to_date: "",
                days: 0,
                protocol_number: "",
                type: "",
                parental_hours: 0,
                blood_donation_days: 0,
                special_days: 0,
                sick_days: 0,
                other_days: 0,
                reason: "",
                saved: false
            });

            flatpickr(`#fromDate${rowIndex}`, {
                dateFormat: "d/m/Y",
                locale: "el",
                disable: [],
                onDayCreate: function(dObj, dStr, fp, dayElem) {
                    const date = dayElem.dateObj;
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, "0");
                    const day = String(date.getDate()).padStart(2, "0");
                    const dateStr = `${year}-${month}-${day}`;
                    if (greekHolidays[year] && greekHolidays[year].includes(dateStr)) {
                        dayElem.classList.add("holiday");
                    }
                },
                onChange: function(selectedDates, dateStr, instance) {
                    calculateDays(instance.element, rowIndex);
                }
            });

            flatpickr(`#toDate${rowIndex}`, {
                dateFormat: "d/m/Y",
                locale: "el",
                disable: [],
                onDayCreate: function(dObj, dStr, fp, dayElem) {
                    const date = dayElem.dateObj;
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, "0");
                    const day = String(date.getDate()).padStart(2, "0");
                    const dateStr = `${year}-${month}-${day}`;
                    if (greekHolidays[year] && greekHolidays[year].includes(dateStr)) {
                        dayElem.classList.add("holiday");
                    }
                },
                onChange: function(selectedDates, dateStr, instance) {
                    calculateDays(instance.element, rowIndex);
                }
            });

            autoResizeTextarea(document.getElementById(`protocolNumber${rowIndex}`));
            autoResizeTextarea(document.getElementById(`reason${rowIndex}`));
        }

        function cancelLeaveRow(index) {
            leaves.splice(index, 1);
            renderLeaveTable();
        }

        async function calculateDays(input, index) {
            const row = input.parentElement.parentElement;
            const fromInput = row.cells[1].querySelector("input");
            const toInput = row.cells[2].querySelector("input");
            let fromStr = fromInput.value.split(" (")[0];
            let toStr = toInput.value.split(" (")[0];
            const rangeWarning = document.getElementById(`rangeHolidayWarning${index}`);

            console.log(`Input fromStr: ${fromStr}, toStr: ${toStr}`);

            if (fromStr && toStr) {
                const [fromDay, fromMonth, fromYear] = fromStr.split("/").map(Number);
                const [toDay, toMonth, toYear] = toStr.split("/").map(Number);

                const start = new Date(fromYear, fromMonth - 1, fromDay, 12, 0, 0);
                const end = new Date(toYear, toMonth - 1, toDay, 12, 0, 0);

                console.log(`Parsed start: ${start.toISOString()}, end: ${end.toISOString()}`);

                if (toYear !== fromYear) {
                    alert("Η ημερομηνία ΕΩΣ πρέπει να είναι στο ίδιο έτος με την ΑΠΟ!");
                    toInput.value = "";
                    leaves[index].to_date = "";
                    row.cells[3].querySelector(".days").textContent = "0";
                    rangeWarning.style.display = "none";
                    return;
                }

                if (end < start) {
                    alert("Η ημερομηνία ΕΩΣ πρέπει να είναι ίδια ή μεταγενέστερη από την ΑΠΟ!");
                    toInput.value = fromStr;
                    rangeWarning.style.display = "none";
                    return;
                }

                const year = start.getFullYear();
                if (!greekHolidays[year]) {
                    greekHolidays[year] = await getGreekHolidays(year);
                }
                const holidays = greekHolidays[year];
                console.log(`Holidays for ${year}:`, holidays);

                let totalDays = 0;
                let holidayCount = 0;
                let weekendPairs = 0;
                let current = new Date(start);
                const daysOfWeek = ["Κυριακή", "Δευτέρα", "Τρίτη", "Τετάρτη", "Πέμπτη", "Παρασκευή", "Σάββατο"];

                const oneDay = 24 * 60 * 60 * 1000;
                const diffDays = Math.round(Math.abs((end - start) / oneDay)) + 1;

                const dateArray = [];
                for (let i = 0; i < diffDays; i++) {
                    const currentDate = new Date(start.getTime() + i * oneDay);
                    dateArray.push({
                        date: currentDate,
                        dateStr: currentDate.toISOString().split('T')[0],
                        dayOfWeek: currentDate.getDay()
                    });
                }

                for (let i = 0; i < dateArray.length; i++) {
                    const { dateStr, dayOfWeek } = dateArray[i];
                    const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                    const isHoliday = holidays.includes(dateStr);

                    console.log(`Checking ${dateStr}: isHoliday=${isHoliday}, isWeekend=${isWeekend}`);

                    if (!isHoliday && !isWeekend) {
                        totalDays++;
                    }
                    if (isHoliday) holidayCount++;
                }

                for (let i = 0; i < dateArray.length - 1; i++) {
                    const currentDay = dateArray[i].dayOfWeek;
                    const nextDay = dateArray[i + 1].dayOfWeek;
                    if (currentDay === 6 && nextDay === 0) {
                        weekendPairs++;
                        i++;
                    }
                }

                if (dateArray.length === 1) {
                    if (dateArray[0].dayOfWeek === 0 || dateArray[0].dayOfWeek === 6) {
                        weekendPairs = 1;
                    }
                } else {
                    if (dateArray[0].dayOfWeek === 0) {
                        weekendPairs++;
                    }
                    if (dateArray[dateArray.length - 1].dayOfWeek === 6) {
                        weekendPairs++;
                    }
                }

                fromInput.value = `${fromStr} (${daysOfWeek[start.getDay()]})`;
                toInput.value = `${toStr} (${daysOfWeek[end.getDay()]})`;

                let warningText = "";
                if (holidayCount > 0) warningText += `Το εύρος περιλαμβάνει ${holidayCount} αργίες`;
                if (weekendPairs > 0) warningText += (warningText ? " & " : "") + `<span class='weekend'>Το εύρος περιλαμβάνει ${weekendPairs} Σ/Κ</span>`;

                rangeWarning.innerHTML = warningText;
                rangeWarning.style.display = warningText ? "block" : "none";

                row.cells[3].querySelector(".days").textContent = totalDays;
                leaves[index].from_date = `${fromYear}-${fromMonth.toString().padStart(2, "0")}-${fromDay.toString().padStart(2, "0")}`;
                leaves[index].to_date = `${toYear}-${toMonth.toString().padStart(2, "0")}-${toDay.toString().padStart(2, "0")}`;
                leaves[index].days = totalDays;

                const parentalInput = row.cells[7].querySelector("input[type='radio']");
                const bloodDonationInput = row.cells[10].querySelector("input[type='radio']");

                parentalInput.disabled = totalDays > 1;
                if (totalDays > 1 && parentalInput.checked) {
                    parentalInput.checked = false;
                    leaves[index].type = "";
                }
                
            } else {
                rangeWarning.style.display = "none";
            }
        }

        function updateLeave(index) {
            const row = document.getElementById("leaveTableBody").rows[index];
            const selectedType = row.querySelector(`input[name="leave${index}"]:checked`);
            const parentalHoursInput = row.cells[7].querySelector(".parental-hours-input");

            leaves[index].type = selectedType ? selectedType.value : "";
            parentalHoursInput.style.display = leaves[index].type === "parental" ? "inline-block" : "none";
            if (leaves[index].type !== "parental") {
                parentalHoursInput.value = "";
                leaves[index].parental_hours = 0;
            }
        }

async function saveLeave(index) {
    const leave = leaves[index];
    if (!leave.from_date || !leave.to_date) {
        alert("Παρακαλώ συμπληρώστε τις ημερομηνίες ΑΠΟ και ΕΩΣ!");
        return;
    }
    if (!leave.type) {
        alert("Παρακαλώ επιλέξτε έναν τύπο άδειας!");
        return;
    }

    const protocolNumber = document.getElementById(`protocolNumber${index}`).value || null;
    const reason = document.getElementById(`reason${index}`).value || null;
    const totalParentalHours = leave.type === "parental" ? (parseInt(document.getElementById(`parentalHours${index}`).value) || 0) : 0;

    if (reason && reason.length > 50) {
        alert("Η αιτιολογία δεν μπορεί να υπερβαίνει τους 50 χαρακτήρες!");
        return;
    }

    if (leave.type === "special") {
        const totalSpecialDaysTaken = leaves
            .filter(l => l.saved && l.special && new Date(l.from_date).getFullYear() === selectedYear)
            .reduce((sum, l) => sum + l.special_days, 0);
        if (totalSpecialDaysTaken + leave.days > TOTAL_SPECIAL_DAYS) {
            alert(`Ο εργαζόμενος έχει ξεπεράσει το όριο των ${TOTAL_SPECIAL_DAYS} ημερών Υ.Δ για το ${selectedYear}!`);
            return;
        }
    }

    const leaveData = {
        employee_id: selectedEmployee.id,
        from_date: leave.from_date,
        to_date: leave.to_date,
        days: leave.days,
        protocol_number: protocolNumber,
        regular: leave.type === "regular",
        sick: leave.type === "sick",
        parental: leave.type === "parental",
        educational: leave.type === "educational",
        special: leave.type === "special",
        blood_donation: leave.type === "blood_donation",
        day_off: leave.type === "day_off",
        other: leave.type === "other",
        parental_hours: totalParentalHours,
        blood_donation_days: leave.type === "blood_donation" ? leave.days : 0,
        special_days: leave.type === "special" ? leave.days : 0,
        sick_days: leave.type === "sick" ? leave.days : 0,
        other_days: leave.type === "other" ? leave.days : 0,
        reason: reason
    };

    const { data, error } = await supabase.from("leaves").insert(leaveData).select();
    if (error) {
        console.error("Error saving leave:", error);
        alert("Σφάλμα κατά την αποθήκευση της άδειας: " + error.message);
        return;
    }
    leaves[index] = { ...data[0], saved: true };
    renderLeaveTable();
    await updateTotals();
}

        async function deleteLeave(leaveId) {
            console.log("Attempting to delete leave with ID:", leaveId);

            const leaveIndex = leaves.findIndex(leave => leave.id === leaveId);
            let leave = leaveIndex !== -1 ? leaves[leaveIndex] : null;

            if (!leave) {
                const { data, error } = await supabase
                    .from("leaves")
                    .select("*")
                    .eq("id", leaveId)
                    .single();
                if (error || !data) {
                    console.error("Error fetching leave from database or not found:", error);
                    alert("Η άδεια δεν βρέθηκε στη βάση!");
                    return;
                }
                leave = data;
                console.log("Leave fetched from database:", leave);
            }

            if (!confirm("Είστε σίγουροι ότι θέλετε να διαγράψετε αυτήν την άδεια;")) {
                console.log("Deletion cancelled by user");
                return;
            }

            console.log("Confirmed deletion for leave ID:", leaveId);
            try {
                const { error } = await supabase
                    .from("leaves")
                    .delete()
                    .eq("id", leaveId);

                if (error) {
                    console.error("Error deleting leave from database:", error);
                    alert("Σφάλμα κατά τη διαγραφή της άδειας: " + error.message);
                    return;
                }

                console.log("Leave deleted successfully from database:", leaveId);
                if (leaveIndex !== -1) {
                    leaves.splice(leaveIndex, 1);
                } else {
                    const { data: updatedLeaves, error: leavesError } = await supabase
                        .from("leaves")
                        .select("*")
                        .eq("employee_id", selectedEmployee.id);
                    if (leavesError) {
                        console.error("Error reloading leaves:", leavesError);
                    } else {
                        leaves = updatedLeaves.map(leave => ({ ...leave, saved: true }));
                    }
                }
                renderLeaveTable();
                await updateTotals();
            } catch (err) {
                console.error("Unexpected error during deletion:", err);
                alert("Προέκυψε απρόσμενο σφάλμα κατά τη διαγραφή!");
            }
        }

async function updateTotals() {
    const previous = parseInt(document.getElementById("previous").value) || 0;
    // Εξασφαλίζουμε ότι παίρνουμε την ακριβή τιμή από το UI, ακόμα και αν είναι 0
    const totalSickDaysInput = document.getElementById("totalSickDays").value;
    const totalOtherDaysInput = document.getElementById("totalOtherDays").value;
    const totalSickDays = totalSickDaysInput === "" ? DEFAULT_SICK_DAYS : parseInt(totalSickDaysInput); // Default μόνο αν είναι κενό
    const totalOtherDays = totalOtherDaysInput === "" ? DEFAULT_OTHER_DAYS : parseInt(totalOtherDaysInput); // Default μόνο αν είναι κενό

    let regularDays = 0;
    let totalParentalHoursTaken = 0;
    let totalBloodDonationDaysTaken = 0;
    let totalSpecialDaysTaken = 0;
    let totalSickDaysTaken = 0;
    let totalOtherDaysTaken = 0;

    // Υπολογισμός των χρησιμοποιημένων ημερών από τις άδειες
    leaves.forEach(leave => {
        const leaveYear = new Date(leave.from_date).getFullYear();
        if (leave.saved && leaveYear === currentYear) {
            if (leave.regular) regularDays += leave.days;
            if (leave.parental) totalParentalHoursTaken += leave.parental_hours || 0;
            if (leave.blood_donation) totalBloodDonationDaysTaken += leave.blood_donation_days || 0;
            if (leave.special) totalSpecialDaysTaken += leave.special_days || 0;
            if (leave.sick) totalSickDaysTaken += leave.sick_days || leave.days;
            if (leave.other) totalOtherDaysTaken += leave.other_days || leave.days;
        }
    });

    const entitled = selectedEmployee.entitled;
    const total = entitled + previous;
    const remaining = Math.max(total - regularDays, 0);
    const totalParentalHours = calculateTotalParentalHours(selectedEmployee);
    const remainingParentalHours = Math.max(totalParentalHours - totalParentalHoursTaken, 0);
    const remainingBloodDonationDays = Math.max(TOTAL_BLOOD_DONATION_DAYS - totalBloodDonationDaysTaken, 0);
    const remainingSpecialDays = Math.max(TOTAL_SPECIAL_DAYS - totalSpecialDaysTaken, 0);
    const remainingSickDays = Math.max(totalSickDays - totalSickDaysTaken, 0);
    const remainingOtherDays = Math.max(totalOtherDays - totalOtherDaysTaken, 0);

    // Ενημέρωση UI
    document.getElementById("entitled").textContent = entitled;
    document.getElementById("total").textContent = total;
    document.getElementById("remaining").textContent = remaining;
    document.getElementById("totalParentalHours").textContent = totalParentalHours;
    document.getElementById("remainingParentalHours").textContent = remainingParentalHours;
    document.getElementById("totalBloodDonationDays").textContent = TOTAL_BLOOD_DONATION_DAYS;
    document.getElementById("remainingBloodDonationDays").textContent = remainingBloodDonationDays;
    document.getElementById("totalSpecialDays").textContent = TOTAL_SPECIAL_DAYS;
    document.getElementById("remainingSpecialDays").textContent = remainingSpecialDays;
    document.getElementById("totalSickDays").value = totalSickDays; // Εμφανίζουμε την ακριβή τιμή
    document.getElementById("remainingSickDays").textContent = remainingSickDays;
    document.getElementById("totalOtherDays").value = totalOtherDays; // Εμφανίζουμε την ακριβή τιμή
    document.getElementById("remainingOtherDays").textContent = remainingOtherDays;

    // Ενημέρωση στη βάση δεδομένων
    const { error } = await supabase
        .from("employees")
        .update({
            previous: previous,
            total: total,
            remaining: remaining,
            total_sick_days: totalSickDays, // Αποθηκεύουμε την ακριβή τιμή από το UI
            total_other_days: totalOtherDays // Αποθηκεύουμε την ακριβή τιμή από το UI
        })
        .eq("id", selectedEmployee.id);

    if (error) {
        console.error("Error updating employee totals:", error);
    } else {
        selectedEmployee.previous = previous;
        selectedEmployee.total = total;
        selectedEmployee.remaining = remaining;
        selectedEmployee.total_sick_days = totalSickDays;
        selectedEmployee.total_other_days = totalOtherDays;
    }
}

        function renderLeaveTable() {
            const tbody = document.getElementById("leaveTableBody");
            tbody.innerHTML = "";
            const filteredLeaves = leaves.filter(leave => new Date(leave.from_date).getFullYear() === selectedYear)
                .sort((a, b) => new Date(b.from_date) - new Date(a.from_date));

            filteredLeaves.forEach(async (leave, index) => {
                const row = document.createElement("tr");
                const daysOfWeek = ["Κυριακή", "Δευτέρα", "Τρίτη", "Τετάρτη", "Πέμπτη", "Παρασκευή", "Σάββατο"];
                const fromDate = new Date(leave.from_date);
                const toDate = new Date(leave.to_date);
                const fromDisplay = `${leave.from_date.split('-').reverse().join('/')} (${daysOfWeek[fromDate.getDay()]})`;
                const toDisplay = `${leave.to_date.split('-').reverse().join('/')} (${daysOfWeek[toDate.getDay()]})`;

                const year = fromDate.getFullYear();
                if (!greekHolidays[year]) {
                    greekHolidays[year] = await getGreekHolidays(year);
                }
                const holidays = greekHolidays[year];
                let holidayCount = 0;
                let weekendCount = 0;
                let current = new Date(fromDate);
                while (current <= toDate) {
                    const dateStr = current.toISOString().split('T')[0];
                    const dayOfWeek = current.getDay();
                    if (holidays.includes(dateStr)) holidayCount++;
                    if (dayOfWeek === 0 || dayOfWeek === 6) weekendCount++;
                    current.setDate(current.getDate() + 1);
                }

                let warningText = "";
                if (holidayCount > 0) warningText += "Το εύρος περιλαμβάνει αργίες";
                if (weekendCount > 0) warningText += (warningText ? " & " : "") + "<span class='weekend'>Το εύρος περιλαμβάνει Σ/Κ</span>";

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><input type="text" class="flatpickr" id="fromDate${index}" value="${fromDisplay}" ${leave.saved ? 'disabled' : ''} onchange="calculateDays(this, ${index})"><span class="holiday-warning" id="rangeHolidayWarning${index}">${warningText}</span></td>
                    <td><input type="text" class="flatpickr" id="toDate${index}" value="${toDisplay}" ${leave.saved ? 'disabled' : ''} onchange="calculateDays(this, ${index})"></td>
                    <td><span class="days">${leave.days}</span></td>
                    <td><textarea class="protocol-input" id="protocolNumber${index}" placeholder="Αρ. Πρωτ. (προαιρετικό)" ${leave.saved ? 'disabled' : ''} oninput="autoResizeTextarea(this)">${leave.protocol_number || ''}</textarea></td>
                    <td><input type="radio" name="leave${index}" value="regular" ${leave.regular ? "checked" : ""} ${leave.saved ? 'disabled' : ''} onchange="updateLeave(${index})"></td>
                    <td><input type="radio" name="leave${index}" value="sick" ${leave.sick ? "checked" : ""} ${leave.saved ? 'disabled' : ''} onchange="updateLeave(${index})"></td>
                    <td><input type="radio" name="leave${index}" value="parental" ${leave.parental ? "checked" : ""} ${leave.saved ? 'disabled' : ''} ${leave.days > 1 ? 'disabled' : ''} onchange="updateLeave(${index})"><input type="number" class="parental-hours-input" id="parentalHours${index}" value="${leave.parental_hours || ''}" placeholder="Ώρες" min="0" ${leave.saved ? 'disabled' : ''} style="display: ${leave.parental ? 'inline-block' : 'none'};"></td>
                    <td><input type="radio" name="leave${index}" value="educational" ${leave.educational ? "checked" : ""} ${leave.saved ? 'disabled' : ''} onchange="updateLeave(${index})"></td>
                    <td><input type="radio" name="leave${index}" value="special" ${leave.special ? "checked" : ""} ${leave.saved ? 'disabled' : ''} onchange="updateLeave(${index})"></td>
                    <td><input type="radio" name="leave${index}" value="blood_donation" ${leave.blood_donation ? "checked" : ""} ${leave.saved ? 'disabled' : ''} onchange="updateLeave(${index})"></td>
                    <td><input type="radio" name="leave${index}" value="day_off" ${leave.day_off ? "checked" : ""} ${leave.saved ? 'disabled' : ''} onchange="updateLeave(${index})"></td>
                    <td><input type="radio" name="leave${index}" value="other" ${leave.other ? "checked" : ""} ${leave.saved ? 'disabled' : ''} onchange="updateLeave(${index})"></td>
                    <td><textarea class="reason-input" id="reason${index}" maxlength="50" placeholder="Αιτιολογία (προαιρετικό, max 50)" ${leave.saved ? 'disabled' : ''} oninput="autoResizeTextarea(this)">${leave.reason || ''}</textarea></td>
                    <td class="leave-actions">
                        ${!leave.saved ? `<button class="cancel-btn" onclick="cancelLeaveRow(${index})">X</button><button onclick="saveLeave(${index})">Αποθήκευση</button>` : `<button onclick="deleteLeave('${leave.id}')">Διαγραφή</button>`}
                    </td>
                    <td></td>
                    <td></td>
                    <td><img src="/signature.png" alt="Υπογραφή Προϊσταμένου" style="max-width: 100px; height: auto;"></td>
                `;
                tbody.appendChild(row);

                document.getElementById(`rangeHolidayWarning${index}`).style.display = warningText ? "block" : "none";

                if (!leave.saved) {
                    flatpickr(`#fromDate${index}`, {
                        dateFormat: "d/m/Y",
                        locale: "el",
                        disable: [],
                        onDayCreate: function(dObj, dStr, fp, dayElem) {
                            const date = dayElem.dateObj;
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, "0");
                            const day = String(date.getDate()).padStart(2, "0");
                            const dateStr = `${year}-${month}-${day}`;
                            if (greekHolidays[year] && greekHolidays[year].includes(dateStr)) {
                                dayElem.classList.add("holiday");
                            }
                        },
                        onChange: function(selectedDates, dateStr, instance) {
                            calculateDays(instance.element, index);
                        }
                    });

                    flatpickr(`#toDate${index}`, {
                        dateFormat: "d/m/Y",
                        locale: "el",
                        disable: [],
                        onDayCreate: function(dObj, dStr, fp, dayElem) {
                            const date = dayElem.dateObj;
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, "0");
                            const day = String(date.getDate()).padStart(2, "0");
                            const dateStr = `${year}-${month}-${day}`;
                            if (greekHolidays[year] && greekHolidays[year].includes(dateStr)) {
                                dayElem.classList.add("holiday");
                            }
                        },
                        onChange: function(selectedDates, dateStr, instance) {
                            calculateDays(instance.element, index);
                        }
                    });
                }

                autoResizeTextarea(document.getElementById(`protocolNumber${index}`));
                autoResizeTextarea(document.getElementById(`reason${index}`));
            });

            generateReport();
        }

        function printLeaves() {
            window.print();
        }

        function generateReport() {
            let totalDays = 0, regularDays = 0, sickDays = 0, parentalDays = 0, parentalHours = 0, educationalDays = 0, specialDays = 0, bloodDonationDays = 0, dayOffDays = 0, otherDays = 0;

            const filteredLeaves = leaves.filter(leave => new Date(leave.from_date).getFullYear() === selectedYear);
            filteredLeaves.forEach(leave => {
                if (leave.saved) {
                    totalDays += leave.days;
                    if (leave.regular) regularDays += leave.days;
                    if (leave.sick) sickDays += leave.days;
                    if (leave.parental) {
                        parentalDays += leave.days;
                        parentalHours += leave.parental_hours || 0;
                    }
                    if (leave.educational) educationalDays += leave.days;
                    if (leave.special) specialDays += leave.days;
                    if (leave.blood_donation) bloodDonationDays += leave.days;
                    if (leave.day_off) dayOffDays += leave.days;
                    if (leave.other) otherDays += leave.days;
                }
            });

            document.getElementById("reportYear").textContent = selectedYear;
            document.getElementById("totalLeaveDays").textContent = totalDays;
            document.getElementById("regularDays").textContent = regularDays;
            document.getElementById("sickDays").textContent = sickDays;
            document.getElementById("parentalDays").textContent = parentalDays;
            document.getElementById("parentalHours").textContent = parentalHours;
            document.getElementById("educationalDays").textContent = educationalDays;
            document.getElementById("specialDays").textContent = specialDays;
            document.getElementById("bloodDonationDays").textContent = bloodDonationDays;
            document.getElementById("dayOffDays").textContent = dayOffDays;
            document.getElementById("otherDays").textContent = otherDays;
        }
    </script>
    <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'920c54455aea8bbc',t:'MTc0MjA0NTA0Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.left='-9999px';a.style.top='-9999px';a.onload=c;document.body.appendChild(a)}})();</script>
</body>
</html>
