<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Διαχείριση Αδειών Εργαζομένων</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .employee-list { margin-bottom: 20px; }
        .employee { cursor: pointer; padding: 10px; border: 1px solid #ccc; margin: 5px 0; }
        .employee:hover { background-color: #f0f0f0; }
        .details { display: none; border: 1px solid #ddd; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        .form-container { margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>Λίστα Εργαζομένων</h1>
    <div class="form-container">
        <h3>Προσθήκη Νέου Εργαζομένου</h3>
        <input type="text" id="surname" placeholder="Επώνυμο"><br>
        <input type="text" id="name" placeholder="Όνομα"><br>
        <input type="text" id="afm" placeholder="ΑΦΜ"><br>
        <input type="email" id="email" placeholder="Email"><br>
        <button onclick="addEmployee()">Προσθήκη</button>
    </div>
    <div class="employee-list" id="employeeList"></div>

    <div class="details" id="employeeDetails">
        <h2 id="employeeName"></h2>
        <div class="summary">
            <label>Δικαιούται 2025: <input type="number" id="entitled" value="25" readonly></label><br>
            <label>Υπόλοιπα προηγούμενου έτους: <input type="number" id="previous" min="0" onchange="updateTotals()"></label><br>
            <label>Σύνολα 2025: <span id="total"></span></label><br>
            <label>Υπόλοιπα: <span id="remaining"></span></label>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Α/Α</th><th>ΑΠΟ</th><th>ΕΩΣ</th><th>ΜΕΡΕΣ</th><th>ΚΑΝΟΝΙΚΗ</th><th>ΑΝΑΡ/ΚΗ</th><th>ΓΟΝΙΚΗ</th><th>ΕΚΠ/ΚΗ</th><th>Υ.Δ</th><th>ΑΙΜΟΔΟΣΙΑ</th><th>ΡΕΠΟ</th><th>ΑΛΛΗ</th><th>ΥΠΑΛΛΗΛΟΣ</th><th>ΤΜΗΜΑΤΑΡΧΗΣ</th><th>ΠΡΟΪΣΤΑΜΕΝΟΣ</th>
                </tr>
            </thead>
            <tbody id="leaveTable"></tbody>
        </table>
        <button onclick="addLeaveRow()">Προσθήκη Άδειας</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = "https://nsrksmlqruogmckxpqer.supabase.co"; // Αντικατέστησε με το δικό σου
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zcmtzbWxxcnVvZ21ja3hwcWVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE3NjYwNjQsImV4cCI6MjA1NzM0MjA2NH0.NydawPjtyBG83qH79uY6rWqCFZleJ6zfo-ZgkRw5QoY"; // Αντικατέστησε με το δικό σου
        const supabase = Supabase.createClient(supabaseUrl, supabaseKey);

        let selectedEmployee = null;
        let leaves = [];

        // Φόρτωση εργαζομένων
        async function loadEmployees() {
            const { data, error } = await supabase.from("employees").select("*");
            if (error) console.error(error);
            else {
                const employeeList = document.getElementById("employeeList");
                employeeList.innerHTML = "";
                data.forEach((emp) => {
                    const div = document.createElement("div");
                    div.className = "employee";
                    div.textContent = `${emp.surname} ${emp.name} | ${emp.afm} | ${emp.email}`;
                    div.onclick = () => showDetails(emp);
                    employeeList.appendChild(div);
                });
            }
        }
        loadEmployees();

        // Προσθήκη νέου εργαζομένου
        async function addEmployee() {
            const surname = document.getElementById("surname").value;
            const name = document.getElementById("name").value;
            const afm = document.getElementById("afm").value;
            const email = document.getElementById("email").value;
            if (surname && name && afm && email) {
                const { error } = await supabase.from("employees").insert({
                    surname, name, afm, email, previous: 0
                });
                if (error) console.error(error);
                else {
                    loadEmployees();
                    document.getElementById("surname").value = "";
                    document.getElementById("name").value = "";
                    document.getElementById("afm").value = "";
                    document.getElementById("email").value = "";
                }
            } else {
                alert("Συμπληρώστε όλα τα πεδία!");
            }
        }

        // Εμφάνιση λεπτομερειών
        async function showDetails(emp) {
            selectedEmployee = emp;
            document.getElementById("employeeDetails").style.display = "block";
            document.getElementById("employeeName").textContent = `${emp.surname} ${emp.name}`;
            document.getElementById("previous").value = emp.previous || 0;
            const { data, error } = await supabase
                .from("leaves")
                .select("*")
                .eq("employee_id", emp.id);
            if (error) console.error(error);
            else {
                leaves = data || [];
                updateTotals();
                renderLeaveTable();
            }
        }

        // Προσθήκη άδειας
        async function addLeaveRow() {
            const tbody = document.getElementById("leaveTable");
            const row = document.createElement("tr");
            const rowIndex = leaves.length + 1;

            row.innerHTML = `
                <td>${rowIndex}</td>
                <td><input type="date" onchange="calculateDays(this)"></td>
                <td><input type="date" onchange="calculateDays(this)"></td>
                <td><span class="days"></span></td>
                <td><input type="checkbox" onchange="updateTotals()"></td>
                <td><input type="checkbox"></td>
                <td><input type="checkbox"></td>
                <td><input type="checkbox"></td>
                <td><input type="checkbox"></td>
                <td><input type="checkbox"></td>
                <td><input type="checkbox"></td>
                <td><input type="checkbox"></td>
                <td></td><td></td><td></td>
            `;
            tbody.appendChild(row);
            const newLeave = {
                employee_id: selectedEmployee.id,
                from_date: "",
                to_date: "",
                days: 0,
                regular: false,
                sick: false,
                parental: false,
                educational: false,
                special: false,
                blood_donation: false,
                day_off: false,
                other: false
            };
            const { data, error } = await supabase.from("leaves").insert(newLeave).select();
            if (error) console.error(error);
            else {
                leaves.push(data[0]);
            }
        }

        // Υπολογισμός ημερών
        async function calculateDays(input) {
            const row = input.parentElement.parentElement;
            const from = row.cells[1].querySelector("input").value;
            const to = row.cells[2].querySelector("input").value;
            if (from && to) {
                const start = new Date(from);
                const end = new Date(to);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                row.cells[3].querySelector(".days").textContent = days;
                const index = Array.from(row.parentElement.children).indexOf(row);
                leaves[index].from_date = from;
                leaves[index].to_date = to;
                leaves[index].days = days;
                await supabase
                    .from("leaves")
                    .update({ from_date: from, to_date: to, days: days })
                    .eq("id", leaves[index].id);
                updateTotals();
            }
        }

        // Ενημέρωση συνόλων
        async function updateTotals() {
            const entitled = parseInt(document.getElementById("entitled").value) || 0;
            const previous = parseInt(document.getElementById("previous").value) || 0;
            selectedEmployee.previous = previous;
            const total = entitled + previous;
            document.getElementById("total").textContent = total;

            let regularDays = 0;
            leaves.forEach((leave, index) => {
                const row = document.getElementById("leaveTable").rows[index];
                leave.regular = row.cells[4].querySelector("input").checked;
                leave.sick = row.cells[5].querySelector("input").checked;
                leave.parental = row.cells[6].querySelector("input").checked;
                leave.educational = row.cells[7].querySelector("input").checked;
                leave.special = row.cells[8].querySelector("input").checked;
                leave.blood_donation = row.cells[9].querySelector("input").checked;
                leave.day_off = row.cells[10].querySelector("input").checked;
                leave.other = row.cells[11].querySelector("input").checked;
                if (leave.regular) regularDays += leave.days;
                supabase.from("leaves").update(leave).eq("id", leave.id);
            });
            document.getElementById("remaining").textContent = total - regularDays;
            await supabase
                .from("employees")
                .update({ previous: previous })
                .eq("id", selectedEmployee.id);
        }

        // Εμφάνιση πίνακα αδειών
        function renderLeaveTable() {
            const tbody = document.getElementById("leaveTable");
            tbody.innerHTML = "";
            leaves.forEach((leave, index) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><input type="date" value="${leave.from_date}" onchange="calculateDays(this)"></td>
                    <td><input type="date" value="${leave.to_date}" onchange="calculateDays(this)"></td>
                    <td><span class="days">${leave.days}</span></td>
                    <td><input type="checkbox" ${leave.regular ? "checked" : ""} onchange="updateTotals()"></td>
                    <td><input type="checkbox" ${leave.sick ? "checked" : ""} onchange="updateTotals()"></td>
                    <td><input type="checkbox" ${leave.parental ? "checked" : ""} onchange="updateTotals()"></td>
                    <td><input type="checkbox" ${leave.educational ? "checked" : ""} onchange="updateTotals()"></td>
                    <td><input type="checkbox" ${leave.special ? "checked" : ""} onchange="updateTotals()"></td>
                    <td><input type="checkbox" ${leave.blood_donation ? "checked" : ""} onchange="updateTotals()"></td>
                    <td><input type="checkbox" ${leave.day_off ? "checked" : ""} onchange="updateTotals()"></td>
                    <td><input type="checkbox" ${leave.other ? "checked" : ""} onchange="updateTotals()"></td>
                    <td></td><td></td><td></td>
                `;
                tbody.appendChild(row);
            });
        }
    </script>
</body>
</html>