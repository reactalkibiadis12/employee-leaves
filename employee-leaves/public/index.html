<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Διαχείριση Αδειών Εργαζομένων</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .employee-list { margin-bottom: 20px; }
        .employee { display: flex; align-items: center; padding: 10px; border: 1px solid #ccc; margin: 5px 0; cursor: pointer; }
        .employee:hover { background-color: #f0f0f0; }
        .employee button { margin-left: 10px; padding: 5px 10px; }
        .details { display: none; border: 1px solid #ddd; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        .form-container, .edit-form { margin-bottom: 20px; }
        .edit-form { display: none; border: 1px solid #ccc; padding: 10px; background-color: #f9f9f9; }
        .leave-actions { display: flex; gap: 5px; }
        @media print {
            body * { visibility: hidden; }
            #leaveTable, #leaveTable * { visibility: visible; }
            #leaveTable { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>
    <h1>Λίστα Εργαζομένων</h1>
    <div class="form-container">
        <h3>Προσθήκη Νέου Εργαζομένου</h3>
        <input type="text" id="surname" placeholder="Επώνυμο"><br>
        <input type="text" id="name" placeholder="Όνομα"><br>
        <input type="text" id="afm" placeholder="ΑΦΜ"><br>
        <input type="email" id="email" placeholder="Email"><br>
        <button onclick="addEmployee()">Προσθήκη</button>
    </div>
    <div class="employee-list" id="employeeList"></div>

    <div class="edit-form" id="editForm">
        <h3>Επεξεργασία Εργαζομένου</h3>
        <input type="text" id="editSurname" placeholder="Επώνυμο"><br>
        <input type="text" id="editName" placeholder="Όνομα"><br>
        <input type="text" id="editAfm" placeholder="ΑΦΜ"><br>
        <input type="email" id="editEmail" placeholder="Email"><br>
        <button onclick="saveEdit()">Αποθήκευση</button>
        <button onclick="cancelEdit()">Ακύρωση</button>
    </div>

    <div class="details" id="employeeDetails">
        <h2 id="employeeName"></h2>
        <div class="summary">
            <label>Δικαιούται 2025: <input type="number" id="entitled" value="25" readonly></label><br>
            <label>Υπόλοιπα προηγούμενου έτους: <input type="number" id="previous" min="0" onchange="updateTotals()"></label><br>
            <label>Σύνολα 2025: <span id="total"></span></label><br>
            <label>Υπόλοιπα: <span id="remaining"></span></label>
        </div>
        <table id="leaveTable">
            <thead>
                <tr>
                    <th>Α/Α</th><th>ΑΠΟ</th><th>ΕΩΣ</th><th>ΜΕΡΕΣ</th><th>ΚΑΝΟΝΙΚΗ</th><th>ΑΝΑΡ/ΚΗ</th><th>ΓΟΝΙΚΗ</th><th>ΕΚΠ/ΚΗ</th><th>Υ.Δ</th><th>ΑΙΜΟΔΟΣΙΑ</th><th>ΡΕΠΟ</th><th>ΑΛΛΗ</th><th>ΕΝΕΡΓΕΙΕΣ</th>
                </tr>
            </thead>
            <tbody id="leaveTableBody"></tbody>
        </table>
        <button onclick="addLeaveRow()">Προσθήκη Άδειας</button>
        <button onclick="printLeaves()">Εκτύπωση Αδειών</button>
    </div>

    <!-- Φόρτωση του Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
        // Δημιουργία του Supabase client με τα δικά σου στοιχεία
        const supabaseUrl = "https://nsrksmlqruogmckxpqer.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zcmtzbWxxcnVvZ21ja3hwcWVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE3NjYwNjQsImV4cCI6MjA1NzM0MjA2NH0.NydawPjtyBG83qH79uY6rWqCFZleJ6zfo-ZgkRw5QoY";
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let selectedEmployee = null;
        let leaves = [];
        let editingEmployee = null;

        // Φόρτωση εργαζομένων
        async function loadEmployees() {
            const { data, error } = await supabase.from("employees").select("*");
            if (error) {
                console.error("Error loading employees:", error);
                return;
            }
            const employeeList = document.getElementById("employeeList");
            employeeList.innerHTML = "";
            data.forEach((emp) => {
                const div = document.createElement("div");
                div.className = "employee";
                div.innerHTML = `
                    <span onclick="showDetails(${emp.id})">${emp.surname} ${emp.name} | ${emp.afm} | ${emp.email}</span>
                    <button onclick="editEmployee(${emp.id})">Επεξεργασία</button>
                    <button onclick="deleteEmployee(${emp.id})">Διαγραφή</button>
                `;
                employeeList.appendChild(div);
            });
        }
        loadEmployees();

        // Προσθήκη νέου εργαζομένου
        async function addEmployee() {
            const surname = document.getElementById("surname").value;
            const name = document.getElementById("name").value;
            const afm = document.getElementById("afm").value;
            const email = document.getElementById("email").value;
            if (surname && name && afm && email) {
                const { error } = await supabase.from("employees").insert({
                    surname, name, afm, email, previous: 0
                });
                if (error) {
                    console.error("Error adding employee:", error);
                    return;
                }
                loadEmployees();
                document.getElementById("surname").value = "";
                document.getElementById("name").value = "";
                document.getElementById("afm").value = "";
                document.getElementById("email").value = "";
            } else {
                alert("Συμπληρώστε όλα τα πεδία!");
            }
        }

        // Διαγραφή εργαζομένου
        async function deleteEmployee(id) {
            if (confirm("Είστε σίγουροι ότι θέλετε να διαγράψετε αυτόν τον εργαζόμενο;")) {
                const { error: leavesError } = await supabase
                    .from("leaves")
                    .delete()
                    .eq("employee_id", id);
                if (leavesError) {
                    console.error("Error deleting leaves:", leavesError);
                    return;
                }
                const { error } = await supabase
                    .from("employees")
                    .delete()
                    .eq("id", id);
                if (error) {
                    console.error("Error deleting employee:", error);
                    return;
                }
                loadEmployees();
                if (selectedEmployee && selectedEmployee.id === id) {
                    document.getElementById("employeeDetails").style.display = "none";
                    selectedEmployee = null;
                }
                if (editingEmployee && editingEmployee.id === id) {
                    document.getElementById("editForm").style.display = "none";
                    editingEmployee = null;
                }
            }
        }

        // Επεξεργασία εργαζομένου
        async function editEmployee(id) {
            const { data, error } = await supabase
                .from("employees")
                .select("*")
                .eq("id", id)
                .single();
            if (error) {
                console.error("Error fetching employee for edit:", error);
                return;
            }
            editingEmployee = data;
            document.getElementById("editSurname").value = data.surname;
            document.getElementById("editName").value = data.name;
            document.getElementById("editAfm").value = data.afm;
            document.getElementById("editEmail").value = data.email;
            document.getElementById("editForm").style.display = "block";
        }

        // Αποθήκευση αλλαγών στην επεξεργασία
        async function saveEdit() {
            const surname = document.getElementById("editSurname").value;
            const name = document.getElementById("editName").value;
            const afm = document.getElementById("editAfm").value;
            const email = document.getElementById("editEmail").value;
            if (surname && name && afm && email) {
                const { error } = await supabase
                    .from("employees")
                    .update({ surname, name, afm, email })
                    .eq("id", editingEmployee.id);
                if (error) {
                    console.error("Error updating employee:", error);
                    return;
                }
                loadEmployees();
                document.getElementById("editForm").style.display = "none";
                if (selectedEmployee && selectedEmployee.id === editingEmployee.id) {
                    selectedEmployee = { ...selectedEmployee, surname, name, afm, email };
                    document.getElementById("employeeName").textContent = `${surname} ${name}`;
                }
                editingEmployee = null;
            } else {
                alert("Συμπληρώστε όλα τα πεδία!");
            }
        }

        // Ακύρωση επεξεργασίας
        function cancelEdit() {
            document.getElementById("editForm").style.display = "none";
            editingEmployee = null;
        }

        // Εμφάνιση λεπτομερειών
        async function showDetails(id) {
            const { data, error } = await supabase
                .from("employees")
                .select("*")
                .eq("id", id)
                .single();
            if (error) {
                console.error("Error loading employee details:", error);
                return;
            }
            selectedEmployee = data;
            document.getElementById("employeeDetails").style.display = "block";
            document.getElementById("employeeName").textContent = `${data.surname} ${data.name}`;
            document.getElementById("previous").value = data.previous || 0;
            const { data: leavesData, error: leavesError } = await supabase
                .from("leaves")
                .select("*")
                .eq("employee_id", data.id);
            if (leavesError) {
                console.error("Error loading leaves:", leavesError);
                return;
            }
            leaves = leavesData || [];
            updateTotals();
            renderLeaveTable();
        }

        // Προσθήκη νέας άδειας
        function addLeaveRow() {
            const tbody = document.getElementById("leaveTableBody");
            const rowIndex = leaves.length + 1;
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${rowIndex}</td>
                <td><input type="date" onchange="calculateDays(this, ${rowIndex - 1})"></td>
                <td><input type="date" onchange="calculateDays(this, ${rowIndex - 1})"></td>
                <td><span class="days">0</span></td>
                <td><input type="checkbox" onchange="updateLeave(${rowIndex - 1})"></td>
                <td><input type="checkbox" onchange="updateLeave(${rowIndex - 1})"></td>
                <td><input type="checkbox" onchange="updateLeave(${rowIndex - 1})"></td>
                <td><input type="checkbox" onchange="updateLeave(${rowIndex - 1})"></td>
                <td><input type="checkbox" onchange="updateLeave(${rowIndex - 1})"></td>
                <td><input type="checkbox" onchange="updateLeave(${rowIndex - 1})"></td>
                <td><input type="checkbox" onchange="updateLeave(${rowIndex - 1})"></td>
                <td><input type="checkbox" onchange="updateLeave(${rowIndex - 1})"></td>
                <td class="leave-actions">
                    <button onclick="saveLeave(${rowIndex - 1})">Save</button>
                    <button onclick="deleteLeave(${rowIndex - 1})" disabled>Delete</button>
                </td>
            `;
            tbody.appendChild(row);
            leaves.push({
                employee_id: selectedEmployee.id,
                from_date: "",
                to_date: "",
                days: 0,
                regular: false,
                sick: false,
                parental: false,
                educational: false,
                special: false,
                blood_donation: false,
                day_off: false,
                other: false,
                saved: false // Flag για να δείχνει αν έχει αποθηκευτεί
            });
        }

        // Υπολογισμός ημερών
        function calculateDays(input, index) {
            const row = input.parentElement.parentElement;
            const from = row.cells[1].querySelector("input").value;
            const to = row.cells[2].querySelector("input").value;
            if (from && to) {
                const start = new Date(from);
                const end = new Date(to);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                row.cells[3].querySelector(".days").textContent = days;
                leaves[index].from_date = from;
                leaves[index].to_date = to;
                leaves[index].days = days;
            }
        }

        // Ενημέρωση πεδίων άδειας
        function updateLeave(index) {
            const row = document.getElementById("leaveTableBody").rows[index];
            leaves[index].regular = row.cells[4].querySelector("input").checked;
            leaves[index].sick = row.cells[5].querySelector("input").checked;
            leaves[index].parental = row.cells[6].querySelector("input").checked;
            leaves[index].educational = row.cells[7].querySelector("input").checked;
            leaves[index].special = row.cells[8].querySelector("input").checked;
            leaves[index].blood_donation = row.cells[9].querySelector("input").checked;
            leaves[index].day_off = row.cells[10].querySelector("input").checked;
            leaves[index].other = row.cells[11].querySelector("input").checked;
        }

        // Αποθήκευση άδειας στη βάση
        async function saveLeave(index) {
            const leave = leaves[index];
            if (!leave.from_date || !leave.to_date) {
                alert("Παρακαλώ συμπληρώστε τις ημερομηνίες ΑΠΟ και ΕΩΣ!");
                return;
            }
            if (leave.saved) {
                // Ενημέρωση υπάρχουσας άδειας
                const { error } = await supabase
                    .from("leaves")
                    .update({
                        from_date: leave.from_date,
                        to_date: leave.to_date,
                        days: leave.days,
                        regular: leave.regular,
                        sick: leave.sick,
                        parental: leave.parental,
                        educational: leave.educational,
                        special: leave.special,
                        blood_donation: leave.blood_donation,
                        day_off: leave.day_off,
                        other: leave.other
                    })
                    .eq("id", leave.id);
                if (error) {
                    console.error("Error updating leave:", error);
                    return;
                }
            } else {
                // Προσθήκη νέας άδειας
                const { data, error } = await supabase
                    .from("leaves")
                    .insert({
                        employee_id: selectedEmployee.id,
                        from_date: leave.from_date,
                        to_date: leave.to_date,
                        days: leave.days,
                        regular: leave.regular,
                        sick: leave.sick,
                        parental: leave.parental,
                        educational: leave.educational,
                        special: leave.special,
                        blood_donation: leave.blood_donation,
                        day_off: leave.day_off,
                        other: leave.other
                    })
                    .select();
                if (error) {
                    console.error("Error saving leave:", error);
                    return;
                }
                leaves[index] = data[0];
                leaves[index].saved = true;
            }
            const row = document.getElementById("leaveTableBody").rows[index];
            row.cells[12].querySelector("button:nth-child(2)").disabled = false; // Ενεργοποίηση Delete
            updateTotals();
        }

        // Διαγραφή άδειας
        async function deleteLeave(index) {
            if (confirm("Είστε σίγουροι ότι θέλετε να διαγράψετε αυτήν την άδεια;")) {
                const leave = leaves[index];
                if (leave.saved) {
                    const { error } = await supabase
                        .from("leaves")
                        .delete()
                        .eq("id", leave.id);
                    if (error) {
                        console.error("Error deleting leave:", error);
                        return;
                    }
                }
                leaves.splice(index, 1);
                renderLeaveTable();
                updateTotals();
            }
        }

        // Ενημέρωση συνόλων
        async function updateTotals() {
            const entitled = parseInt(document.getElementById("entitled").value) || 0;
            const previous = parseInt(document.getElementById("previous").value) || 0;
            selectedEmployee.previous = previous;
            const total = entitled + previous;
            document.getElementById("total").textContent = total;

            let regularDays = 0;
            leaves.forEach((leave) => {
                if (leave.saved && leave.regular) regularDays += leave.days;
            });
            document.getElementById("remaining").textContent = total - regularDays;

            await supabase
                .from("employees")
                .update({ previous: previous })
                .eq("id", selectedEmployee.id);
        }

        // Εμφάνιση πίνακα αδειών
        function renderLeaveTable() {
            const tbody = document.getElementById("leaveTableBody");
            tbody.innerHTML = "";
            leaves.forEach((leave, index) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><input type="date" value="${leave.from_date}" onchange="calculateDays(this, ${index})"></td>
                    <td><input type="date" value="${leave.to_date}" onchange="calculateDays(this, ${index})"></td>
                    <td><span class="days">${leave.days}</span></td>
                    <td><input type="checkbox" ${leave.regular ? "checked" : ""} onchange="updateLeave(${index})"></td>
                    <td><input type="checkbox" ${leave.sick ? "checked" : ""} onchange="updateLeave(${index})"></td>
                    <td><input type="checkbox" ${leave.parental ? "checked" : ""} onchange="updateLeave(${index})"></td>
                    <td><input type="checkbox" ${leave.educational ? "checked" : ""} onchange="updateLeave(${index})"></td>
                    <td><input type="checkbox" ${leave.special ? "checked" : ""} onchange="updateLeave(${index})"></td>
                    <td><input type="checkbox" ${leave.blood_donation ? "checked" : ""} onchange="updateLeave(${index})"></td>
                    <td><input type="checkbox" ${leave.day_off ? "checked" : ""} onchange="updateLeave(${index})"></td>
                    <td><input type="checkbox" ${leave.other ? "checked" : ""} onchange="updateLeave(${index})"></td>
                    <td class="leave-actions">
                        <button onclick="saveLeave(${index})">Save</button>
                        <button onclick="deleteLeave(${index})" ${leave.saved ? "" : "disabled"}>Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Εκτύπωση αδειών
        function printLeaves() {
            window.print();
        }
    </script>
</body>
</html>
